<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Pages - Arcator</title>
    <link href="./master.css" rel="stylesheet">
    <link href="./favicon.png" rel="icon" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="antialiased">

<div id="navbar-placeholder"></div>

<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" id="loading-spinner">
    <div class="animate-spin rounded-full h-32 w-32 border-b-2 border-white"></div>
    </div>

<section class="hero-banner">
    <div class="hero-overlay"></div>
    <div class="hero-content">
        <h1 class="text-5xl font-bold mb-4">Pages</h1>
        <p class="text-xl">View Custom Pages</p>
    </div>
</section>

<main class="container mx-auto px-4 py-8">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="pages-list">

    </div>
</main>

<div id="footer-placeholder"></div>

<script type="module">
    import {db, COLLECTIONS} from './firebase-init.js';
    import {initializePage, loadFooter} from './core.js';
    import {showMessageBox} from './utils.js';
    import {themeManager} from './theme-manager.js';
    import {
        collection,
        getDocs,
        query,
        orderBy
    } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';
    import {appId} from "./firebase-init";

    function handleError(error, context = '') {
        console.error(`${context}:`, error);
        showMessageBox(`Error: ${error.message || 'An unknown error occurred'}`, true);
    }

    async function loadPages() {
        const pagesList = document.getElementById('pages-list');
        if (!pagesList) {
            console.error('Pages list element not found');
            return;
        }

        try {
            if (!db) {
                throw new Error('Firestore not initialized');
            }

            pagesList.innerHTML = '<div class="col-span-full text-center">Loading pages...</div>';

            const pagesPath = `artifacts/${appId}/public/data/pages`;
            const pagesRef = collection(db, pagesPath);
            const pagesQuery = query(pagesRef, orderBy('createdAt', 'desc'));
            const snapshot = await getDocs(pagesQuery);

            if (snapshot.empty) {
                pagesList.innerHTML = '<div class="col-span-full text-center text-text-secondary">No pages found</div>';
                return;
            }

            pagesList.innerHTML = snapshot.docs.map(doc => {
                const page = doc.data();
                return `
                        <div class="bg-card rounded-lg shadow-lg p-6 hover:shadow-xl transition-all">
                            <h3 class="text-xl font-semibold mb-2">${page.title || 'Untitled Page'}</h3>
                            <p class="text-text-secondary mb-4">${page.description || 'No description'}</p>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-text-secondary">
                                    Created: ${page.createdAt ? new Date(page.createdAt.toDate()).toLocaleDateString() : 'Unknown'}
                                </span>
                                <a href="./page.html?id=${doc.id}" class="btn-primary">
                                    View Page
                                </a>
                            </div>
                        </div>
                    `;
            }).join('');
        } catch (error) {
            handleError(error, 'Loading pages');
            pagesList.innerHTML = '<div class="col-span-full text-center text-red-500">Error loading pages</div>';
        }
    }

    async function init() {
        try {
            await Promise.all([
                initializePage('pages'),
                themeManager.init()
            ]);

            await loadPages();
            await loadFooter();
        } catch (error) {
            handleError(error, 'Initializing page');
        }
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init().catch(error => handleError(error, 'Page load'));
    }
</script>
</body>
</html>