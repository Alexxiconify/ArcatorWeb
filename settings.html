<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Settings - Arcator.co.uk</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts - Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <!-- Link to the CSS variables in themes.html -->
  <link rel="stylesheet" href="themes.html">
  <!-- Import themes.js for centralized JavaScript functions -->
  <script src="themes.js" type="module"></script>
  <!-- Import custom_theme_modal.js for custom theme management logic -->
  <script src="custom_theme_modal.js" type="module"></script>
  <style>
    /* Base styles */
    body {
      font-family: 'Inter', sans-serif;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* Hero Banner styles - common for all themes, retains background image */
    .hero-banner {
      background-image: url('https://jylina.arcator.co.uk/standalone/img/creativespawn.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      min-height: 250px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }
    .hero-banner::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5); /* Dark overlay for text readability */
      z-index: 1;
    }
    .hero-content {
      position: relative;
      z-index: 2;
      color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
    }

    /* Settings card styling */
    .settings-card {
      max-width: 600px;
      width: 90%;
      padding: 2.5rem;
      border-radius: 0.75rem;
      box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
    }
    .input-field {
      margin-bottom: 1rem;
    }
    .input-field label {
      display: block;
      margin-bottom: 0.5rem;
      font-size: 0.875rem; /* text-sm */
      font-weight: 600; /* font-semibold */
    }
    .input-field input, .input-field select {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--color-input-border); /* Use CSS variable */
      border-radius: 0.5rem; /* rounded-md */
      font-size: 1rem;
    }
    .btn-primary {
      width: 100%;
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: 700; /* font-bold */
      transition: background-color 0.2s, transform 0.2s;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
    }

    /* Message box styling */
    .message-box {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: var(--color-modal-bg); /* Use modal background for consistency */
      color: var(--color-modal-text); /* Use modal text for consistency */
      padding: 15px 30px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      display: none; /* Hidden by default */
      font-size: 1rem;
      text-align: center;
    }
    .message-box.success {
      background-color: var(--color-message-box-bg-success);
    }
    .message-box.error {
      background-color: var(--color-message-box-bg-error);
    }

    /* Modal for custom themes */
    .modal {
      display: none; /* Hidden by default */
      position: fixed; /* Stay in place */
      z-index: 1001; /* Sit on top */
      left: 0;
      top: 0;
      width: 100%; /* Full width */
      height: 100%; /* Full height */
      overflow: auto; /* Enable scroll if needed */
      background-color: rgba(0,0,0,0.7); /* Black w/ opacity */
      display: flex; /* Use flex for centering */
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: var(--color-modal-bg);
      color: var(--color-modal-text);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.5);
      width: 90%;
      max-width: 600px;
      position: relative;
    }

    /* Fix for blank text around color pickers */
    .modal-content label {
      color: var(--color-modal-text); /* Ensure labels within modal are visible */
    }
    .close-button {
      color: var(--color-text-secondary);
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close-button:hover,
    .close-button:focus {
      color: var(--color-text-primary);
      text-decoration: none;
    }
  </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen antialiased">
<!-- Navbar Placeholder -->
<div id="navbar-placeholder" class="w-full absolute top-0 left-0"></div>

<div class="settings-container w-full max-w-md mx-auto p-4 flex flex-col items-center mt-20">
  <!-- Settings Card -->
  <div id="settings-section" class="settings-card bg-card text-primary shadow-xl mb-6">
    <h2 class="text-3xl font-bold text-center mb-6">User Settings</h2>
    <div id="loading-spinner" class="flex justify-center items-center h-24">
      <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-blue-500"></div>
    </div>
    <div id="settings-content" class="hidden">
      <p class="text-center text-lg mb-4">Logged in as: <span id="user-email-display" class="font-semibold"></span></p>
      <div class="flex flex-col items-center mb-6">
        <img id="profile-picture-display" class="profile-pic-large mb-4" src="https://placehold.co/128x128/1F2937/E5E7EB?text=AV" alt="Current Profile Picture" onerror="this.onerror=null;this.src='https://placehold.co/128x128/1F2937/E5E7EB?text=AV';">
        <label for="profile-picture-url" class="block text-secondary text-sm font-bold mb-2">Profile Picture URL (e.g., Discord CDN Link):</label>
        <input type="url" id="profile-picture-url" class="py-2 px-3" placeholder="https://cdn.discordapp.com/avatars/USER_ID/AVATAR_HASH.png">
        <p id="url-preview-message" class="text-secondary text-sm mt-2" style="display: none;">Previewing new URL. Click Save Settings to apply.</p>
      </div>

      <div class="input-field">
        <label for="display-name">Display Name:</label>
        <input type="text" id="display-name" placeholder="Your Display Name" class="py-2 px-3">
      </div>
      <div class="input-field">
        <label for="user-theme-select">Select Theme:</label>
        <select id="user-theme-select" class="py-2 px-3">
          <!-- Options will be dynamically populated -->
        </select>
      </div>
      <div class="input-field">
        <label for="font-size-select">Font Size:</label>
        <select id="font-size-select" class="py-2 px-3">
          <option value="14px">Small (14px)</option>
          <option value="16px">Medium (16px)</option>
          <option value="18px">Large (18px)</option>
          <option value="20px">Extra Large (20px)</option>
        </select>
      </div>
      <button id="save-settings-btn" class="btn-primary btn-blue mb-4">Save Settings</button>
      <button id="logout-btn" class="btn-primary btn-red">Log Out</button>

      <div class="mt-8 pt-8 border-t border-gray-700">
        <h3 class="text-2xl font-bold text-center text-heading-main mb-6">Custom Themes</h3>
        <p class="text-secondary text-center mb-4">Create, edit, or delete your own personalized themes.</p>
        <button id="create-custom-theme-btn" class="btn-primary btn-green mb-4">Create New Custom Theme</button>

        <div class="overflow-x-auto">
          <table class="min-w-full text-left table-auto mt-4">
            <thead>
            <tr>
              <th class="px-4 py-2">Theme Name</th>
              <th class="px-4 py-2">Actions</th>
            </tr>
            </thead>
            <tbody id="custom-theme-list-tbody">
            <tr><td colspan="2" class="text-center py-4 text-secondary">No custom themes.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Custom Theme and Confirmation Modals will be loaded here -->
<div id="modals-placeholder"></div>


<!-- Firebase SDKs -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    signOut,
    signInAnonymously,
    signInWithCustomToken,
    updateProfile // Import updateProfile for Firebase Auth display name/photoURL
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import {
    getFirestore,
    doc,
    getDoc,
    setDoc,
    collection,
    getDocs,
    deleteDoc,
    addDoc // Make sure addDoc is imported
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // Import functions from custom_theme_modal.js
  // Changed from './custom_theme_modal.js' to 'custom_theme_modal.js'
  import { setupCustomThemeManagement, renderCustomThemeList, openCustomThemeModal } from 'custom_theme_modal.js';


  // Global variables provided by the Canvas environment
  const canvasAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
  // __firebase_config is already an object, no need to parse
  const firebaseConfig = typeof __firebase_config !== 'undefined' ? __firebase_config : {};
  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

  const appId = canvasAppId; // Use the provided __app_id

  let app;
  let auth;
  let db;
  let isFirebaseInitialized = false;

  // DOM Elements
  const loadingSpinner = document.getElementById('loading-spinner');
  const settingsContent = document.getElementById('settings-content');
  const userEmailDisplay = document.getElementById('user-email-display');
  const displayNameInput = document.getElementById('display-name');
  const userThemeSelect = document.getElementById('user-theme-select');
  const profilePictureDisplay = document.getElementById('profile-picture-display');
  const profilePictureUrlInput = document.getElementById('profile-picture-url');
  const urlPreviewMessage = document.getElementById('url-preview-message');
  const saveSettingsBtn = document.getElementById('save-settings-btn');
  const logoutBtn = document.getElementById('logout-btn');
  const messageBox = document.getElementById('message-box');
  const createCustomThemeBtn = document.getElementById('create-custom-theme-btn');
  const customThemeListTbody = document.getElementById('custom-theme-list-tbody');
  const fontSizeSelect = document.getElementById('font-size-select'); // New: Font size select element

  const DEFAULT_PROFILE_PIC = 'https://placehold.co/128x128/1F2937/E5E7EB?text=AV'; // Default placeholder
  const DEFAULT_THEME_NAME = 'dark'; // Default theme name

  /**
   * Displays a custom message box for user feedback.
   * This function needs to be globally accessible for custom_theme_modal.js
   * @param {string} message - The message to display.
   * @param {boolean} isError - True for error, false for success.
   */
  window.showMessageBox = function(message, isError) {
    // Only attempt to update if messageBox element exists
    if (messageBox) {
      messageBox.textContent = message;
      messageBox.className = 'message-box'; // Reset classes
      if (isError) {
        messageBox.classList.add('error');
      } else {
        messageBox.classList.add('success');
      }
      messageBox.style.display = 'block';
      setTimeout(() => {
        messageBox.style.display = 'none';
      }, 5000); // Hide after 5 seconds
    } else {
      console.warn("showMessageBox called before messageBox element was available:", message);
    }
  }

  // Initialize Firebase
  try {
    // Only initialize if firebaseConfig has keys (i.e., it's not an empty object)
    if (Object.keys(firebaseConfig).length > 0) {
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getFirestore(app);
      isFirebaseInitialized = true;
      console.log("Firebase initialized successfully.");
    } else {
      console.warn("Firebase configuration is empty. Settings features requiring Firestore will be disabled.");
    }
  } catch (e) {
    console.error("Error initializing Firebase:", e);
  }

  /**
   * Fetches user profile data from Firestore.
   * Made globally accessible for custom_theme_modal.js
   * @param {string} uid - The user's UID.
   * @returns {Promise<Object|null>} - User profile data or null if not found.
   */
  window.getUserProfileFromFirestore = async function(uid) {
    if (!db) {
      console.error("Firestore DB not initialized for getUserProfileFromFirestore.");
      return null;
    }
    const userDocRef = doc(db, `artifacts/${appId}/public/data/user_profiles`, uid);
    try {
      const docSnap = await getDoc(userDocRef);
      if (docSnap.exists()) {
        return docSnap.data();
      }
    } catch (error) {
      console.error("Error fetching user profile:", error);
      window.showMessageBox(`Error loading profile: ${error.message}`, true);
    }
    return null;
  }

  /**
   * Updates user profile data in Firestore.
   * Made globally accessible for custom_theme_modal.js
   * @param {string} uid - The user's UID.
   * @param {Object} profileData - The data to update (themePreference, displayName, photoURL, fontSizePreference).
   */
  window.updateUserProfileInFirestore = async function(uid, profileData) {
    if (!db) {
      window.showMessageBox("Database not initialized. Cannot save profile.", true);
      return false;
    }
    const userDocRef = doc(db, `artifacts/${appId}/public/data/user_profiles`, uid);
    try {
      await setDoc(userDocRef, profileData, { merge: true }); // Use merge to avoid overwriting other fields
      window.showMessageBox("Settings saved successfully!", false);
      return true;
    } catch (error) {
      console.error("Error updating user profile in Firestore:", error);
      window.showMessageBox(`Error saving settings: ${error.message}`, true);
      return false;
    }
  }

  /**
   * Populates the theme selection dropdown.
   */
  async function populateThemeSelect() {
    userThemeSelect.innerHTML = ''; // Clear existing options
    const availableThemes = await window.getAvailableThemes(); // Get all themes from themes.js

    availableThemes.forEach(theme => {
      const option = document.createElement('option');
      option.value = theme.id; // Use ID for both predefined and custom themes
      option.textContent = theme.name;
      userThemeSelect.appendChild(option);
    });
  }

  /**
   * Applies the selected font size to the document body.
   * @param {string} fontSize - The font size value (e.g., '16px').
   */
  function applyFontSize(fontSize) {
    document.body.style.fontSize = fontSize;
  }

  // This function encapsulates the initial authentication and UI setup logic
  async function initializeUserSettings() {
    loadingSpinner.classList.remove('hidden'); // Ensure spinner is visible initially
    settingsContent.classList.add('hidden');

    const authStatePromise = new Promise(resolve => {
      const unsubscribe = onAuthStateChanged(auth, async (user) => {
        unsubscribe();
        resolve(user);
      });
    });

    let user = await authStatePromise;

    if (!user && initialAuthToken) {
      try {
        console.log("Attempting anonymous sign-in with initialAuthToken...");
        await signInAnonymously(auth);
        user = auth.currentUser;
        console.log("Anonymous sign-in complete. User:", user?.uid);
      } catch (error) {
        console.error("ERROR: Initial anonymous sign-in failed:", error);
        window.showMessageBox("Could not sign in automatically. Please log in manually.", true);
      }
    }

    loadingSpinner.classList.add('hidden'); // Hide spinner after all initial auth checks

    if (user) {
      console.log("User is logged in.", user.uid);
      settingsContent.classList.remove('hidden');

      const userProfile = await window.getUserProfileFromFirestore(user.uid);
      userEmailDisplay.textContent = user.email || "Anonymous User";
      displayNameInput.value = userProfile?.displayName || user.displayName || '';
      profilePictureUrlInput.value = userProfile?.photoURL || user.photoURL || '';

      if (profilePictureDisplay) {
        profilePictureDisplay.src = userProfile?.photoURL || user.photoURL || DEFAULT_PROFILE_PIC;
      }

      await populateThemeSelect();
      userThemeSelect.value = userProfile?.themePreference || DEFAULT_THEME_NAME;
      const allThemes = await window.getAvailableThemes();
      const selectedThemeForApply = allThemes.find(theme => theme.id === userThemeSelect.value);
      if (selectedThemeForApply) {
        window.applyTheme(selectedThemeForApply.id, selectedThemeForApply);
      } else {
        window.applyTheme(DEFAULT_THEME_NAME);
      }

      // Set and apply font size preference
      const savedFontSize = userProfile?.fontSizePreference || '16px'; // Default to 16px
      fontSizeSelect.value = savedFontSize;
      applyFontSize(savedFontSize);

      if (isFirebaseInitialized) {
        setupCustomThemeManagement(
          db, auth, appId, window.showMessageBox, populateThemeSelect, userThemeSelect, DEFAULT_THEME_NAME, user
        );
        renderCustomThemeList();
      }

      const navbarUserIcon = document.getElementById('navbar-user-profile-pic');
      const navbarUserDisplayName = document.getElementById('navbar-user-display-name');
      const navbarUserSettingsLink = document.getElementById('navbar-user-settings-link');
      if (navbarUserIcon && navbarUserDisplayName && navbarUserSettingsLink) {
        navbarUserIcon.src = userProfile?.photoURL || user.photoURL || DEFAULT_PROFILE_PIC;
        navbarUserDisplayName.textContent = userProfile?.displayName || user.displayName || 'Settings';
        navbarUserSettingsLink.style.display = 'flex';
      }

    } else {
      console.log("No user logged in. Redirecting to sign.html.");
      window.location.href = 'sign.html';
      settingsContent.classList.add('hidden');
      window.applyTheme(DEFAULT_THEME_NAME);
      const navbarUserSettingsLink = document.getElementById('navbar-user-settings-link');
      if (navbarUserSettingsLink) {
        navbarUserSettingsLink.style.display = 'none';
      }
      if (!isFirebaseInitialized) {
        window.showMessageBox("Firebase is not initialized. Please ensure your Firebase config is provided.", true);
      }
    }
  }


  // Event Listeners
  if (saveSettingsBtn) {
    saveSettingsBtn.addEventListener('click', async () => {
      if (!auth.currentUser) {
        window.showMessageBox("You must be logged in to save settings.", true);
        return;
      }
      const uid = auth.currentUser.uid;
      const newDisplayName = displayNameInput.value.trim();
      const newThemeId = userThemeSelect.value;
      const newPhotoURL = profilePictureUrlInput.value.trim();
      const newFontSize = fontSizeSelect.value; // Get new font size

      const imageUrlRegex = /^https?:\/\/[^\s$.?#].[^\s]*$/i;
      if (newPhotoURL && !imageUrlRegex.test(newPhotoURL)) {
        window.showMessageBox("Please enter a valid URL for the profile picture (e.g., https://example.com/image.png).", true);
        return;
      }

      try {
        await updateProfile(auth.currentUser, {
          displayName: newDisplayName,
          photoURL: newPhotoURL || null
        });

        const allThemes = await window.getAvailableThemes();
        const selectedTheme = allThemes.find(theme => theme.id === newThemeId);

        await window.updateUserProfileInFirestore(uid, {
          displayName: newDisplayName,
          themePreference: newThemeId,
          photoURL: newPhotoURL || DEFAULT_PROFILE_PIC,
          fontSizePreference: newFontSize // Save font size preference
        });

        if (selectedTheme) {
          window.applyTheme(selectedTheme.id, selectedTheme);
        } else {
          window.applyTheme(DEFAULT_THEME_NAME);
        }
        applyFontSize(newFontSize); // Apply new font size immediately

        if (profilePictureDisplay) {
          profilePictureDisplay.src = newPhotoURL || DEFAULT_PROFILE_PIC;
        }
        urlPreviewMessage.style.display = 'none';

        const navbarUserIcon = document.getElementById('navbar-user-profile-pic');
        const navbarUserDisplayName = document.getElementById('navbar-user-display-name');
        const navbarUserSettingsLink = document.getElementById('navbar-user-settings-link');

        if (navbarUserIcon && navbarUserDisplayName && navbarUserSettingsLink) {
          navbarUserIcon.src = newPhotoURL || DEFAULT_PROFILE_PIC;
          navbarUserDisplayName.textContent = newDisplayName || 'Settings';
        }

      } catch (error) {
        console.error("Error updating profile:", error);
        window.showMessageBox(`Error updating profile: ${error.message || 'Unknown error'}`, true);
      }
    });
  }

  if (logoutBtn) {
    logoutBtn.addEventListener('click', async () => {
      window.showMessageBox("", false);
      try {
        await signOut(auth);
        window.showMessageBox("You have been signed out.", false);
      } catch (error) {
        console.error("Logout failed:", error);
        window.showMessageBox("Logout failed: " + error.message, true);
      }
    });
  }

  // Live preview of profile picture URL
  profilePictureUrlInput.addEventListener('input', () => {
    const url = profilePictureUrlInput.value.trim();
    const imageUrlRegex = /^https?:\/\/[^\s$.?#].[^\s]*$/i;
    if (imageUrlRegex.test(url)) {
      if (profilePictureDisplay) {
        profilePictureDisplay.src = url;
      }
      urlPreviewMessage.textContent = 'Previewing new URL. Click Save Settings to apply.';
      urlPreviewMessage.classList.remove('text-red-500');
      urlPreviewMessage.classList.add('text-secondary');
      urlPreviewMessage.style.display = 'block';
    } else if (url === '') {
      if (profilePictureDisplay) {
        profilePictureDisplay.src = DEFAULT_PROFILE_PIC;
      }
      urlPreviewMessage.style.display = 'none';
    } else {
      if (profilePictureDisplay) {
        profilePictureDisplay.src = DEFAULT_PROFILE_PIC;
      }
      urlPreviewMessage.textContent = 'Invalid URL. Please enter a valid direct link to an image.';
      urlPreviewMessage.classList.remove('text-secondary');
      urlPreviewMessage.classList.add('text-red-500');
      urlPreviewMessage.style.display = 'block';
    }
  });

  // Load modals HTML first, then initialize user settings
  window.onload = async function() {
    await loadNavbar();
    await loadModals();

    const createCustomThemeBtnElement = document.getElementById('create-custom-theme-btn');
    if (createCustomThemeBtnElement && isFirebaseInitialized) {
      setupCustomThemeManagement(db, auth, appId, window.showMessageBox, populateThemeSelect, userThemeSelect, DEFAULT_THEME_NAME, auth.currentUser);
    }

    if (isFirebaseInitialized) {
      await initializeUserSettings();
    } else {
      loadingSpinner.classList.add('hidden');
      window.showMessageBox("Firebase is not initialized. Please ensure your Firebase config is provided.", true);
    }
  };

  // Function to load the navigation bar (if not already defined)
  async function loadNavbar() {
    const navbarPlaceholder = document.getElementById('navbar-placeholder');
    if (navbarPlaceholder) {
      try {
        const response = await fetch('navbar.html');
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const navbarHtml = await response.text();
        navbarPlaceholder.innerHTML = navbarHtml;
      } catch (error) {
        console.error("Failed to load navigation bar:", error);
      }
    }
  }

  // Function to load the custom theme modal HTML
  async function loadModals() {
    const modalsPlaceholder = document.getElementById('modals-placeholder');
    if (modalsPlaceholder) {
      try {
        const response = await fetch('custom_theme_modal.html');
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const modalHtml = await response.text();
        modalsPlaceholder.innerHTML = modalHtml;
      } catch (error) {
        console.error("Failed to load custom theme modal:", error);
      }
    }
  }
</script>
</body>
</html>
