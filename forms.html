<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Forms - Arcator</title>
    <link href="./master.css" rel="stylesheet">
    <link href="./favicon.png" rel="icon" type="image/png">
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js" type="module"></script>
</head>
<body class="antialiased">
<!-- Navbar placeholder -->
<div id="navbar-placeholder"></div>

<!-- Hero Banner -->
<section class="hero-banner">
    <div class="hero-content text-center">
        <h1 class="text-5xl font-bold mb-4">Forms</h1>
        <p class="text-xl mb-8">Submit and manage your forms</p>
    </div>
    </section>

<main class="container mx-auto px-4 py-8">
    <!-- Loading State -->
    <div class="flex items-center justify-center py-12" id="loading-spinner">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white"></div>
    </div>

    <!-- Forms List -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden" id="forms-list">
        <!-- Forms will be populated here -->
    </div>

    <!-- Empty State -->
    <div class="text-center py-12 hidden" id="empty-state">
        <p class="text-xl text-text-secondary">No forms available at the moment.</p>
    </div>

    <!-- Create Form Button (Admin Only) -->
    <div class="mt-8 hidden" id="admin-controls">
        <button class="btn-primary" id="create-form-btn">
            Create New Form
        </button>
    </div>
</main>

<!-- Footer placeholder -->
<div id="footer-placeholder"></div>

<script type="module">
    import {initializePage} from './core.js';
    import {auth, db, appId} from './firebase-init.js';
    import {themeManager} from './theme-manager.js';
    import {showMessageBox} from './utils.js';
    import {
        collection,
        doc,
        getDoc,
        getDocs
    } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

    async function loadForms() {
        const loadingSpinner = document.getElementById('loading-spinner');
        const formsList = document.getElementById('forms-list');
        const emptyState = document.getElementById('empty-state');

        try {
            // Show loading state
            loadingSpinner.classList.remove('hidden');
            formsList.classList.add('hidden');
            emptyState.classList.add('hidden');

            // Get forms from Firestore
            const formsRef = collection(db, 'forms');
            const formsSnapshot = await getDocs(formsRef);
            const forms = [];

            formsSnapshot.forEach(doc => {
                const data = doc.data();
                forms.push({
                    id: doc.id,
                    title: data.title,
                    description: data.description,
                    createdAt: data.createdAt
                });
            });

            // Update UI based on results
            if (forms.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                formsList.innerHTML = forms.map(form => `
                        <div class="bg-card rounded-lg shadow-lg p-6 hover:shadow-xl transition-shadow">
                            <h3 class="text-xl font-semibold mb-2">${form.title || 'Untitled Form'}</h3>
                            <p class="text-text-secondary mb-4">${form.description || 'No description available'}</p>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-text-secondary">
                                    ${form.createdAt ? new Date(form.createdAt.seconds * 1000).toLocaleDateString() : 'Date not available'}
                                </span>
                                <a href="./form.html?id=${form.id}" class="btn-primary">
                                    Open Form
                                </a>
                            </div>
                        </div>
                    `).join('');
                formsList.classList.remove('hidden');
            }
        } catch (error) {
            console.error('Error loading forms:', error);
            showMessageBox('Failed to load forms. Please try again later.', true);
        } finally {
            loadingSpinner.classList.add('hidden');
        }
    }

    // Initialize page
    async function init() {
        try {
            await initializePage('forms', true);
            await themeManager.init();
            await loadForms();

            // Show admin controls if user is admin
            const adminControls = document.getElementById('admin-controls');
            if (auth.currentUser) {
                const userProfileRef = doc(db, `artifacts/${appId}/public/data/user_profiles`, auth.currentUser.uid);
                const userProfile = await getDoc(userProfileRef);
                if (userProfile.exists() && userProfile.data().isAdmin) {
                    adminControls.classList.remove('hidden');
                }
            }
        } catch (error) {
            console.error('Error initializing page:', error);
            showMessageBox('Failed to initialize page. Please try again later.', true);
        }
    }

    // Start initialization
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init().catch(console.error);
    }
</script>
</body>
</html>