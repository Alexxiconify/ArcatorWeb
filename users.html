<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Account - Arcator.co.uk</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts - Inter and others -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto+Mono:wght@400;700&family=Open+Sans:wght@400;700&display=swap" rel="stylesheet">
  <!-- Link to the CSS variables -->
  <link rel="stylesheet" href="theme_variables.css">
  <!-- Link to navbar.css for consistent styling -->
  <link rel="stylesheet" href="navbar.css">
  <!-- Link to settings.css for page-specific styling -->
  <link rel="stylesheet" href="settings.css">
  <!-- Add any specific CSS for sign-in/up forms if not already covered by settings.css -->
  <style>
    /* Basic styles for auth forms for consistency, if not in settings.css */
    .auth-card {
      @apply bg-gray-700 p-8 rounded-lg shadow-xl max-w-md mx-auto my-8 border border-gray-600; /* Added border */
    }
    .auth-input-field {
      @apply mb-4;
    }
    .auth-input-field label {
      @apply block text-gray-300 text-sm font-bold mb-2;
    }
    .auth-input-field input[type="email"],
    .auth-input-field input[type="password"],
    .auth-input-field input[type="text"],
    .auth-input-field input[type="url"] {
      @apply shadow-sm appearance-none border rounded w-full py-2 px-3 text-gray-100 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-800 border-gray-600 transition duration-200 ease-in-out; /* Enhanced input styling */
    }
    .auth-btn-primary {
      @apply bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full focus:outline-none focus:shadow-outline w-full transition duration-300 ease-in-out transform hover:scale-105; /* Slightly adjusted button styling */
    }
    .auth-link {
      @apply inline-block align-baseline font-semibold text-sm text-blue-400 hover:text-blue-200 transition duration-300 ease-in-out; /* Adjusted link styling */
    }

    /* Message box styling (from utils.js) */
    .message-box {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #333;
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .message-box.show {
      opacity: 1;
      visibility: visible;
    }

    .message-box.error {
      background-color: #dc3545;
    }

    .message-box.success {
      background-color: #28a745;
    }

    /* Custom confirm modal styling (from utils.js) */
    .custom-confirm-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      display: none; /* Hidden by default */
    }

    .custom-confirm-modal .modal-content {
      background-color: #2d3748;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
      text-align: center;
      position: relative;
      max-width: 400px;
      width: 90%;
      color: #e2e8f0;
    }

    .custom-confirm-modal .close-button {
      position: absolute;
      top: 10px;
      right: 15px;
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .custom-confirm-modal .close-button:hover,
    .custom-confirm-modal .close-button:focus {
      color: #e2e8f0;
      text-decoration: none;
      cursor: pointer;
    }
  </style>
</head>
<body class="antialiased">
<!-- Navbar Placeholder -->
<div id="navbar-placeholder" class="w-full absolute top-0 left-0"></div>

<!-- Hero Section -->
<section class="hero-banner rounded-b-lg shadow-xl" style="margin-top: 64px;">
  <div class="container mx-auto px-4 text-center hero-content">
    <h1 id="hero-title" class="text-5xl md:text-6xl font-extrabold mb-4 leading-tight">Welcome</h1>
    <p id="hero-subtitle" class="text-xl md:text-2xl mb-8">Manage your account or sign in</p>
  </div>
</section>

<!-- Main Content Area -->
<section class="py-16 bg-gray-800 rounded-lg shadow-inner mx-4 my-8">
  <div class="container mx-auto px-4">
    <div id="loading-spinner" class="flex justify-center items-center h-48" style="display: none;">
      <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
    </div>

    <!-- Sign In Section -->
    <div id="signin-section" class="auth-card" style="display: none;">
      <h2 class="text-3xl font-bold text-blue-400 text-center mb-6">Sign In</h2>
      <form id="signin-form">
        <div class="auth-input-field">
          <label for="signin-email">Email Address</label>
          <input type="email" id="signin-email" placeholder="email@example.com">
        </div>
        <div class="auth-input-field">
          <label for="signin-password">Password</label>
          <input type="password" id="signin-password" placeholder="********">
        </div>
        <div class="mb-6">
          <button type="button" id="signin-btn" class="auth-btn-primary">Sign In</button>
        </div>
        <div class="flex flex-col items-center justify-center space-y-2 text-center mt-4">
          <a href="#" id="go-to-signup-link" class="auth-link">Don't have an account? Sign Up</a>
          <a href="#" id="go-to-forgot-password-link" class="auth-link">Forgot Password?</a>
        </div>
      </form>
    </div>

    <!-- Sign Up Section -->
    <div id="signup-section" class="auth-card" style="display: none;">
      <h2 class="text-3xl font-bold text-green-400 text-center mb-6">Sign Up</h2>
      <form id="signup-form">
        <div class="auth-input-field">
          <label for="signup-display-name">Display Name</label>
          <input type="text" id="signup-display-name" placeholder="Your Display Name">
        </div>
        <div class="auth-input-field">
          <label for="signup-handle">Unique Handle (@)</label>
          <input type="text" id="signup-handle" placeholder="e.g., @gamer_tag">
          <p class="text-xs text-gray-400 mt-1">Only alphanumeric, dots, and underscores allowed.</p>
        </div>
        <div class="auth-input-field">
          <label for="signup-email">Email Address</label>
          <input type="email" id="signup-email" placeholder="email@example.com">
        </div>
        <div class="auth-input-field">
          <label for="signup-password">Password</label>
          <input type="password" id="signup-password" placeholder="********">
        </div>
        <div class="auth-input-field">
          <label for="signup-confirm-password">Confirm Password</label>
          <input type="password" id="signup-confirm-password" placeholder="********">
        </div>
        <div class="mb-6">
          <button type="button" id="signup-btn" class="auth-btn-primary bg-green-600 hover:bg-green-700">Sign Up</button>
        </div>
        <div class="text-center">
          <a href="#" id="go-to-signin-link" class="auth-link">Already have an account? Sign In</a>
        </div>
      </form>
    </div>

    <!-- Forgot Password Section -->
    <div id="forgot-password-section" class="auth-card" style="display: none;">
      <h2 class="text-3xl font-bold text-orange-400 text-center mb-6">Reset Password</h2>
      <form id="forgot-password-form">
        <div class="auth-input-field">
          <label for="forgot-password-email">Email Address</label>
          <input type="email" id="forgot-password-email" placeholder="email@example.com">
        </div>
        <div class="mb-6">
          <button type="button" id="reset-password-btn" class="auth-btn-primary bg-orange-600 hover:bg-orange-700">Send Reset Email</button>
        </div>
        <div class="text-center">
          <a href="#" id="go-to-signin-from-forgot-link" class="auth-link">Back to Sign In</a>
        </div>
      </form>
    </div>

    <!-- Settings Content Section -->
    <div id="settings-content" style="display: none;">
      <h2 class="text-4xl font-bold text-blue-400 text-center mb-10">Manage Your Profile & Preferences</h2>

      <div class="flex flex-col md:flex-row justify-center items-center md:items-start space-y-8 md:space-y-0 md:space-x-8">
        <!-- Profile Picture and Display Name Card -->
        <div class="settings-card bg-gray-700 shadow-xl">
          <h3 class="text-2xl font-bold text-blue-300 mb-6 text-center">Profile Information</h3>
          <div class="flex flex-col items-center mb-6">
            <img id="profile-picture-display" class="w-32 h-32 rounded-full object-cover mb-4 profile-pic-large" src="https://placehold.co/128x128/1F2937/E5E7EB?text=AV" alt="Profile Picture" onerror="this.onerror=null; this.src=window.DEFAULT_PROFILE_PIC;">
            <p id="display-name-text" class="text-gray-200 text-2xl font-semibold">Loading...</p>
            <p id="handle-text" class="text-gray-400 text-lg">Loading...</p> <!-- New handle display -->
            <p id="email-text" class="text-gray-400 text-sm">Loading...</p>
          </div>

          <div class="input-field">
            <label for="display-name-input">Display Name:</label>
            <input type="text" id="display-name-input" placeholder="Your Display Name">
          </div>

          <div class="input-field">
            <label for="handle-input">Unique Handle:</label>
            <input type="text" id="handle-input" placeholder="@yourhandle">
            <p class="text-secondary text-sm mt-1">This will be your unique public identifier.</p>
          </div>

          <div class="input-field">
            <label for="profile-picture-url-input">Profile Picture URL:</label>
            <input type="url" id="profile-picture-url-input" placeholder="https://example.com/your-image.jpg">
            <p id="url-preview-message" class="text-secondary text-sm mt-1" style="display: none;">Enter a direct link to an image (JPG, PNG, GIF).</p>
          </div>

          <button id="save-profile-btn" class="btn-primary btn-blue">Save Profile Changes</button>
        </div>

        <!-- Theme and Font Preferences Card -->
        <div class="settings-card bg-gray-700 shadow-xl">
          <h3 class="text-2xl font-bold text-blue-300 mb-6 text-center">Personalize Experience</h3>

          <div class="input-field">
            <label for="theme-select">Select Theme:</label>
            <select id="theme-select"></select>
          </div>

          <div class="input-field">
            <label for="font-size-select">Base Font Size:</label>
            <select id="font-size-select">
              <option value="14px">Small (14px)</option>
              <option value="16px">Medium (16px)</option>
              <option value="18px">Large (18px)</option>
            </select>
          </div>

          <div class="input-field">
            <label for="font-family-select">Font Family:</label>
            <select id="font-family-select">
              <option value="Inter, sans-serif">Inter</option>
              <option value="Roboto Mono, monospace">Roboto Mono</option>
              <option value="Open Sans, sans-serif">Open Sans</option>
            </select>
          </div>

          <div class="input-field">
            <label for="background-pattern-select">Background Pattern:</label>
            <select id="background-pattern-select">
              <option value="none">None</option>
              <option value="dots">Dots</option>
              <option value="grid">Grid</option>
            </select>
          </div>

          <button id="save-preferences-btn" class="btn-primary btn-green">Save Preferences</button>

          <h3 class="text-2xl font-bold text-blue-300 mb-6 mt-8 text-center">Custom Themes</h3>
          <button id="create-custom-theme-btn" class="btn-primary btn-purple">Create/Manage Custom Themes</button>
        </div>
      </div>

      <!-- Password Management Card -->
      <div class="settings-card bg-gray-700 shadow-xl mx-auto mt-8">
        <h3 class="text-2xl font-bold text-blue-300 mb-6 text-center">Password Management</h3>
        <p class="text-gray-300 text-center mb-4">You must enter your current password to change it.</p>
        <div class="input-field">
          <label for="current-password-input">Current Password:</label>
          <input type="password" id="current-password-input" placeholder="********">
        </div>
        <div class="input-field">
          <label for="new-password-input">New Password:</label>
          <input type="password" id="new-password-input" placeholder="********">
        </div>
        <div class="input-field">
          <label for="confirm-new-password-input">Confirm New Password:</label>
          <input type="password" id="confirm-new-password-input" placeholder="********">
        </div>
        <button id="change-password-btn" class="btn-primary btn-orange">Change Password</button>
      </div>

      <!-- Notification Preferences Card -->
      <div class="settings-card bg-gray-700 shadow-xl mx-auto mt-8">
        <h3 class="text-2xl font-bold text-blue-300 mb-6 text-center">Notification Preferences</h3>
        <p class="text-gray-300 text-center mb-4">Manage how you receive updates and alerts.</p>
        <div class="input-field flex items-center space-x-2">
          <input type="checkbox" id="email-notifications-checkbox" class="form-checkbox h-5 w-5 text-blue-600 rounded">
          <label for="email-notifications-checkbox">Receive Email Notifications</label>
        </div>
        <div class="input-field flex items-center space-x-2">
          <input type="checkbox" id="inapp-notifications-checkbox" class="form-checkbox h-5 w-5 text-blue-600 rounded">
          <label for="inapp-notifications-checkbox">Receive In-App Notifications</label>
        </div>
        <button id="save-notifications-btn" class="btn-primary btn-blue mt-4">Save Notification Settings</button>
      </div>

      <!-- Accessibility Settings Card -->
      <div class="settings-card bg-gray-700 shadow-xl mx-auto mt-8">
        <h3 class="text-2xl font-bold text-blue-300 mb-6 text-center">Accessibility Settings</h3>
        <p class="text-gray-300 text-center mb-4">Adjust settings for improved accessibility.</p>
        <div class="input-field flex items-center space-x-2">
          <input type="checkbox" id="high-contrast-checkbox" class="form-checkbox h-5 w-5 text-blue-600 rounded">
          <label for="high-contrast-checkbox">Enable High Contrast Mode</label>
        </div>
        <div class="input-field flex items-center space-x-2">
          <input type="checkbox" id="reduced-motion-checkbox" class="form-checkbox h-5 w-5 text-blue-600 rounded">
          <label for="reduced-motion-checkbox">Enable Reduced Motion</label>
        </div>
        <button id="save-accessibility-btn" class="btn-primary btn-blue mt-4">Save Accessibility Settings</button>
      </div>

      <!-- Session Information Card -->
      <div class="settings-card bg-gray-700 shadow-xl mx-auto mt-8">
        <h3 class="text-2xl font-bold text-blue-300 mb-6 text-center">Session Information</h3>
        <p id="last-login-time" class="text-gray-300 text-center mb-2">Last Login: N/A</p>
        <p id="account-creation-time" class="text-gray-300 text-center">Account Created: N/A</p>
      </div>

      <!-- Delete Account Card -->
      <div class="settings-card bg-gray-700 shadow-xl mx-auto mt-8">
        <h3 class="text-2xl font-bold text-blue-300 mb-6 text-center">Danger Zone</h3>
        <p class="text-gray-300 text-center mb-4">Enter your password to permanently delete your account.</p>
        <div class="input-field">
          <label for="delete-account-password">Confirm Password:</label>
          <input type="password" id="delete-account-password" placeholder="********">
        </div>
        <button id="delete-account-btn" class="btn-primary btn-red">Delete Account</button>
      </div>
    </div>

    <!-- Message for unauthenticated users (fallback, if not using auth forms) -->
    <div id="login-required-message" class="text-center text-gray-300 text-xl py-12" style="display: none;">
      <p>Please <a href="#" id="link-to-signin" class="text-blue-500 hover:underline">sign in</a> to view and manage your settings.</p>
    </div>

  </div>
</section>

<!-- Message Box Element -->
<div id="message-box" class="message-box"></div>

<!-- Custom Confirmation Modal (for delete operations) -->
<div id="custom-confirm-modal" class="custom-confirm-modal">
  <div class="modal-content">
    <span class="close-button">&times;</span>
    <p class="mb-4 text-lg" id="confirm-message"></p>
    <p class="mb-6 text-sm text-gray-400" id="confirm-submessage"></p>
    <button id="confirm-yes" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full mr-4">Yes</button>
    <button id="confirm-no" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-full">Cancel</button>
  </div>
</div>

<!-- Footer Section -->
<footer class="bg-gray-900 py-8 text-center text-gray-400 rounded-t-lg shadow-inner mt-8">
  <div class="container mx-auto px-4">
    <p>© 2012 - <span id="current-year"></span> Arcator.co.uk. All rights reserved.</p>
    <p class="mt-2">Made with ❤️ for the Minecraft Community.</p>
    <div class="flex flex-wrap justify-center space-x-6 mt-4">
      <a href="privacy.html" class="hover:text-white transition duration-300 ease-in-out">Privacy Policy</a>
      <a href="terms.html" class="hover:text-white transition duration-300 ease-in-out">Terms of Service</a>
      <a href="https://wiki.arcator.co.uk/" target="_blank" rel="noopener noreferrer" class="hover:text-white transition duration-300 ease-in-out">Wiki</a>
      <a href="infrastructure.html" class="hover:text-white transition duration-300 ease-in-out">Infrastructure</a>
      <a href="admin_and_dev.html" class="hover:text-white transition duration-300 ease-in-out">Admin & Dev</a>
    </div>
  </div>
</footer>

<!-- Consolidated and Refactored JavaScript -->
<script type="module">
  // --- Firebase SDK Imports (Consolidated at the very top of the module) ---
  import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import {
    getFirestore,
    doc,
    getDoc,
    setDoc,
    deleteDoc,
    collection,
    getDocs,
    query, // Added query for handle uniqueness check
    where  // Added where for handle uniqueness check
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // ========================================================================
  // Module: Firebase Initialization and User Profile Management
  // Provides global Firebase instances and user profile utilities.
  // ========================================================================
  (function() {
    const firebaseConfig = {
      apiKey: "AIzaSyCP5Zb1CRermAKn7p_S30E8qzCbvsMxhm4",
      authDomain: "arcator-web.firebaseapp.com",
      projectId: "arcator-web",
      storageBucket: "arcator-web.firebasestorage.app",
      messagingSenderId: "1033082068049",
      appId: "1:1033082068049:web:dd154c8b188bde1930ec70",
      measurementId: "G-DJXNT1L7CM"
    };

    const canvasAppId = typeof __app_id !== 'undefined' ? __app_id : null;
    window.appId = canvasAppId || firebaseConfig.projectId || 'default-app-id';

    window.app;
    window.auth;
    window.db;
    window.currentUser = null; // Stores the current authenticated user's profile data

    // Constants exposed globally for ease of access by other modules
    window.DEFAULT_PROFILE_PIC = 'https://placehold.co/32x32/1F2937/E5E7EB?text=AV';
    window.DEFAULT_THEME_NAME = 'dark';
    window.ADMIN_UIDS = ['uOaZ8v76y2Q0X7PzJtU7Y3A2C1B4'];

    let firebaseReadyResolve;
    window.firebaseReadyPromise = new Promise((resolve) => {
      firebaseReadyResolve = resolve;
    });

    /**
     * Fetches user profile data from Firestore.
     * @param {string} uid - The user's UID.
     * @returns {Promise<Object|null>} - User profile data or null if not found.
     */
    window.getUserProfileFromFirestore = async function(uid) {
      await window.firebaseReadyPromise;
      if (!window.db) {
        console.error("Firestore DB not initialized for getUserProfileFromFirestore.");
        return null;
      }
      const userDocRef = doc(window.db, `artifacts/${window.appId}/public/data/user_profiles`, uid);
      try {
        const docSnap = await getDoc(userDocRef);
        if (docSnap.exists()) {
          return { uid: docSnap.id, ...docSnap.data() };
        }
      } catch (error) {
        console.error("Error fetching user profile from Firestore:", error);
      }
      return null;
    };

    /**
     * Sets or updates a user's profile in the 'user_profiles' collection in Firestore.
     * @param {string} uid - The User ID.
     * @param {Object} profileData - The data to set/merge into the user's profile.
     * @returns {boolean} True if successful, false otherwise.
     */
    window.setUserProfileInFirestore = async function(uid, profileData) {
      await window.firebaseReadyPromise;
      if (!window.db) { console.error("Firestore DB not initialized for setUserProfileInFirestore."); return false; }
      const userDocRef = doc(window.db, `artifacts/${window.appId}/public/data/user_profiles`, uid);
      try {
        await setDoc(userDocRef, profileData, { merge: true });
        // Update the global currentUser object if this is the currently logged-in user
        if (window.currentUser && window.currentUser.uid === uid) { window.currentUser = { ...window.currentUser, ...profileData }; }
        console.log("DEBUG: User profile updated in Firestore for UID:", uid);
        return true;
      } catch (error) { console.error("Error updating user profile in Firestore:", error); return false; }
    };

    /**
     * Deletes a user's profile from the 'user_profiles' collection in Firestore.
     * @param {string} uid - The User ID.
     * @returns {boolean} True if successful, false otherwise.
     */
    window.deleteUserProfileFromFirestore = async function(uid) {
      await window.firebaseReadyPromise;
      if (!window.db) { console.error("Firestore DB not initialized for deleteUserProfileFromFirestore."); return false; }
      const userDocRef = doc(window.db, `artifacts/${window.appId}/public/data/user_profiles`, uid);
      try {
        await deleteDoc(userDocRef);
        console.log("DEBUG: User profile deleted from Firestore for UID:", uid);
        return true;
      } catch (error) { console.error("Error deleting user profile from Firestore:", error); return false; }
    };

    /**
     * Initializes Firebase, sets up authentication, and resolves firebaseReadyPromise.
     * This function should be called once at application start.
     */
    async function setupFirebaseAndUser() {
      console.log("DEBUG: setupFirebaseAndUser called.");

      if (getApps().length === 0) {
        let finalFirebaseConfig = firebaseConfig;

        if (typeof __firebase_config !== 'undefined' && __firebase_config !== null) {
          if (typeof __firebase_config === 'string') {
            try {
              finalFirebaseConfig = JSON.parse(__firebase_config);
              console.log("DEBUG: __firebase_config provided as string and parsed successfully.");
            } catch (e) {
              console.error("ERROR: Failed to parse __firebase_config string as JSON. Retaining hardcoded firebaseConfig.", e);
            }
          } else if (typeof __firebase_config === 'object') {
            finalFirebaseConfig = __firebase_config;
            console.log("DEBUG: __firebase_config provided as object. Using directly.");
          } else {
            console.warn("DEBUG: __firebase_config provided but not string or object. Type:", typeof __firebase_config, ". Retaining hardcoded firebaseConfig.");
          }
        } else {
          console.log("DEBUG: __firebase_config not provided. Using hardcoded firebaseConfig.");
        }

        try {
          window.app = initializeApp(finalFirebaseConfig);
          window.auth = getAuth(window.app);
          window.db = getFirestore(window.app);
          console.log("Firebase initialized successfully.");

          const unsubscribe = onAuthStateChanged(window.auth, async (user) => {
            console.log("onAuthStateChanged triggered during initialization. User:", user ? user.uid : "none");
            if (user) {
              let userProfile = await window.getUserProfileFromFirestore(user.uid);
              if (!userProfile) {
                console.log("No profile found. Creating default.");
                userProfile = {
                  uid: user.uid, displayName: user.displayName || `User-${user.uid.substring(0, 6)}`,
                  email: user.email || null, photoURL: window.DEFAULT_PROFILE_PIC,
                  createdAt: new Date(), lastLoginAt: new Date(), themePreference: window.DEFAULT_THEME_NAME,
                  isAdmin: window.ADMIN_UIDS.includes(user.uid),
                  handle: user.uid.substring(0, 6) // Default handle from UID
                };
                await window.setUserProfileInFirestore(user.uid, userProfile);
              } else {
                await window.setUserProfileInFirestore(user.uid, { lastLoginAt: new Date(), isAdmin: window.ADMIN_UIDS.includes(user.uid) });
                userProfile.isAdmin = window.ADMIN_UIDS.includes(user.uid);
              }
              window.currentUser = userProfile;
              console.log("DEBUG: currentUser set:", window.currentUser);
            } else {
              console.log("Auth State Changed: User logged out.");
              window.currentUser = null;
            }
            firebaseReadyResolve();
            unsubscribe();
          });

          if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            console.log("DEBUG: Attempting to sign in with custom token.");
            await signInWithCustomToken(window.auth, __initial_auth_token)
              .then(() => console.log("DEBUG: Signed in with custom token."))
              .catch((error) => {
                console.error("ERROR: Custom token sign-in failed:", error);
              });
          } else {
            console.log("DEBUG: __initial_auth_token not defined. Relying on platform for initial auth state (could be anonymous or null).");
          }
        } catch (e) {
          console.error("Error initializing Firebase (initial block):", e);
          firebaseReadyResolve();
        }
      } else {
        window.app = getApp();
        window.db = getFirestore(window.app);
        window.auth = getAuth(window.app);
        console.log("DEBUG: Firebase app already initialized. Re-using existing app instance.");
        firebaseReadyResolve();
      }
    }
    setupFirebaseAndUser();
  })(); // End Firebase Module

  // ========================================================================
  // Module: Utility Functions (MessageBox, SanitizeHandle, CustomConfirm)
  // Provides general utility functions accessible globally.
  // ========================================================================
  (function() {
    const messageBox = document.getElementById('message-box');
    let messageBoxTimeout;

    window.showMessageBox = function(message, isError = false) {
      if (!messageBox) {
        console.error("Message box element not found.");
        return;
      }
      if (messageBoxTimeout) { clearTimeout(messageBoxTimeout); }
      messageBox.textContent = message;
      messageBox.className = 'message-box';
      if (isError) { messageBox.classList.add('error'); } else { messageBox.classList.add('success'); }
      messageBox.classList.add('show');
      messageBoxTimeout = setTimeout(() => { messageBox.classList.remove('show'); }, 3000);
    };

    window.sanitizeHandle = function(input) {
      // Allow alphanumeric, dots, and underscores
      return input.toLowerCase().replace(/[^a-z0-9_.]/g, '');
    };

    const customConfirmModal = document.getElementById('custom-confirm-modal');
    const confirmMessage = document.getElementById('confirm-message');
    const confirmSubmessage = document.getElementById('confirm-submessage');
    const confirmYesButton = document.getElementById('confirm-yes');
    const confirmNoButton = document.getElementById('confirm-no');
    const closeButton = document.querySelector('.custom-confirm-modal .close-button');
    let resolveConfirmPromise;

    window.showCustomConfirm = function(message, submessage = '') {
      if (!customConfirmModal || !confirmMessage || !confirmYesButton || !confirmNoButton) {
        console.error("Custom confirmation modal elements not found.");
        return Promise.resolve(false);
      }
      confirmMessage.textContent = message;
      confirmSubmessage.textContent = submessage;
      customConfirmModal.style.display = 'flex';
      return new Promise((resolve) => {
        resolveConfirmPromise = resolve;
        confirmYesButton.onclick = null; confirmNoButton.onclick = null; closeButton.onclick = null;
        confirmYesButton.onclick = () => { customConfirmModal.style.display = 'none'; resolveConfirmPromise(true); };
        confirmNoButton.onclick = () => { customConfirmModal.style.display = 'none'; resolveConfirmPromise(false); };
        closeButton.onclick = () => { customConfirmModal.style.display = 'none'; resolveConfirmPromise(false); };
        customConfirmModal.onclick = (event) => {
          if (event.target === customConfirmModal) { customConfirmModal.style.display = 'none'; resolveConfirmPromise(false); }
        };
      });
    };

    document.addEventListener('DOMContentLoaded', () => {
      if (customConfirmModal) {
        console.log("DEBUG-INIT: custom-confirm-modal element found.");
        if (customConfirmModal.style.display === '' || customConfirmModal.style.display === 'block') {
          customConfirmModal.style.display = 'none';
          console.log("DEBUG-INIT: custom-confirm-modal forcibly hidden on script load.");
        } else {
          console.log("DEBUG-INIT: custom-confirm-modal is correctly hidden by default.");
        }
      }
    });
  })(); // End Utils Module

  // ========================================================================
  // Module: Themes Management
  // Handles dynamic theme application, fetching, saving, and deletion.
  // Depends on global Firebase and Utils.
  // ========================================================================
  (function() {
    let _db;
    let _auth;
    let _appId;
    let _themeSelect;
    let _allThemes = [];

    const predefinedThemes = [
      {
        id: 'dark', name: 'Dark Theme',
        variables: {
          '--color-body-bg': '#1a202c', '--color-text-primary': '#e2e8f0', '--color-text-secondary': '#a0aec0',
          '--color-link': '#63b3ed', '--color-link-hover': '#4299e1', '--color-navbar-bg': '#2d3748',
          '--color-card-bg': '#2d3748', '--color-input-bg': '#4a5568', '--color-input-border': '#2d3748',
          '--color-button-bg-primary': '#4299e1', '--color-button-text': '#ffffff',
          '--color-button-hover-primary': '#3182ce', '--color-bg-card': '#2d3748'
        }
      },
      {
        id: 'light', name: 'Light Theme',
        variables: {
          '--color-body-bg': '#f7fafc', '--color-text-primary': '#2d3748', '--color-text-secondary': '#4a5568',
          '--color-link': '#3182ce', '--color-link-hover': '#2b6cb0', '--color-navbar-bg': '#ffffff',
          '--color-card-bg': '#ffffff', '--color-input-bg': '#edf2f7', '--color-input-border': '#e2e8f0',
          '--color-button-bg-primary': '#3182ce', '--color-button-text': '#ffffff',
          '--color-button-hover-primary': '#2b6cb0', '--color-bg-card': '#ffffff'
        }
      }
    ];

    window.setupThemesFirebase = function(dbInstance, authInstance, appIdInstance) {
      _db = dbInstance;
      _auth = authInstance;
      _appId = appIdInstance;
      _themeSelect = document.getElementById('theme-select');
      console.log("DEBUG: Themes Firebase setup complete.");
    };

    async function fetchCustomThemes() {
      if (!_db || !_auth || !_auth.currentUser) {
        console.log("DEBUG: Not fetching custom themes - DB not ready or user not logged in.");
        return [];
      }
      const userId = _auth.currentUser.uid;
      const customThemesColRef = collection(_db, `artifacts/${_appId}/users/${userId}/custom_themes`);
      try {
        const querySnapshot = await getDocs(customThemesColRef);
        const customThemes = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        console.log("DEBUG: Fetched custom themes:", customThemes.length);
        return customThemes;
      } catch (error) {
        console.error("Error fetching custom themes:", error);
        return [];
      }
    }

    async function saveCustomTheme(theme) {
      if (!_db || !_auth || !_auth.currentUser) {
        window.showMessageBox("Please sign in to save custom themes.", true);
        return false;
      }
      const userId = _auth.currentUser.uid;
      const themeDocRef = doc(_db, `artifacts/${_appId}/users/${userId}/custom_themes`, theme.id);
      try {
        await setDoc(themeDocRef, theme);
        window.showMessageBox("Theme saved successfully!", false);
        return true;
      } catch (error) {
        console.error("Error saving custom theme:", error);
        window.showMessageBox("Failed to save theme.", true);
        return false;
      }
    }

    async function deleteCustomTheme(themeId) {
      if (!_db || !_auth || !_auth.currentUser) {
        window.showMessageBox("Please sign in to delete custom themes.", true);
        return false;
      }
      const userId = _auth.currentUser.uid;
      const themeDocRef = doc(_db, `artifacts/${_appId}/users/${userId}/custom_themes`, themeId);
      try {
        await deleteDoc(themeDocRef);
        window.showMessageBox("Theme deleted successfully!", false);
        return true;
      } catch (error) {
        console.error("Error deleting custom theme:", error);
        window.showMessageBox("Failed to delete theme.", true);
        return false;
      }
    }

    window.applyTheme = async function(themeId, themeObject = null) {
      let themeToApply = themeObject;
      if (!themeToApply) { themeToApply = _allThemes.find(t => t.id === themeId); }
      if (!themeToApply) {
        // If themeObject not provided or not found, try fetching all themes again
        _allThemes = [...predefinedThemes, ...(await fetchCustomThemes())];
        themeToApply = _allThemes.find(t => t.id === themeId);
      }
      if (!themeToApply) {
        console.warn(`Theme '${themeId}' not found. Applying default theme.`);
        themeToApply = predefinedThemes.find(t => t.id === window.DEFAULT_THEME_NAME) || predefinedThemes[0];
      }
      if (themeToApply && themeToApply.variables) {
        for (const [key, value] of Object.entries(themeToApply.variables)) {
          document.documentElement.style.setProperty(key, value);
        }
        console.log(`Applied theme: ${themeToApply.name} (${themeToApply.id})`);
      } else {
        console.error(`Failed to apply theme: ${themeId}. Variables not found.`);
      }
    };

    async function populateThemeSelect() {
      _allThemes = [...predefinedThemes, ...(await fetchCustomThemes())];
      if (_themeSelect) {
        _themeSelect.innerHTML = '';
        _allThemes.forEach(theme => {
          const option = document.createElement('option');
          option.value = theme.id;
          option.textContent = theme.name;
          _themeSelect.appendChild(option);
        });
      }
    }

    window.getAvailableThemes = async function() {
      // Ensure _allThemes is populated before returning
      if (_allThemes.length === 0) { await populateThemeSelect(); }
      return _allThemes;
    };

    // Initial population of themes after DOM is ready
    document.addEventListener('DOMContentLoaded', async () => {
      // Themes logic relies on Firebase being ready, handled by main window.onload
      // This listener mainly sets up the theme selection change behavior.
      if (_themeSelect) {
        _themeSelect.addEventListener('change', async (event) => {
          const selectedThemeId = event.target.value;
          await window.applyTheme(selectedThemeId);
          if (window.auth.currentUser) {
            await setDoc(doc(window.db, `artifacts/${window.appId}/public/data/user_profiles`, window.auth.currentUser.uid),
              { themePreference: selectedThemeId }, { merge: true });
          }
        });
      }
    });
  })(); // End Themes Module

  // ========================================================================
  // Module: Navbar Logic
  // Handles dynamically injecting and updating the navigation bar.
  // Depends on global Firebase, Themes, and Utils.
  // ========================================================================
  (function() {
    window.loadNavbar = async function(user, defaultProfilePic, defaultThemeName) {
      const navbarPlaceholder = document.getElementById('navbar-placeholder');
      console.log("DEBUG: loadNavbar function called.");

      if (navbarPlaceholder) {
        console.log("DEBUG: 'navbar-placeholder' element found.");
        try {
          // Use user.handle if available, otherwise substring of UID for display
          const userHandleDisplay = user && user.handle ? `@${user.handle}` : (user && user.uid ? user.uid.substring(0, 6) : '');

          const navbarHtml = `
            <nav class="navbar-bg p-4 shadow-lg w-full">
              <div class="container mx-auto flex justify-between items-center">
                <a href="index.html" class="text-gray-50 text-2xl font-bold">Arcator.co.uk</a>
                <div class="flex items-center space-x-4">
                  <a href="user.html" id="navbar-user-settings-link" class="flex items-center text-gray-300 hover:text-gray-50 px-3 py-2 rounded-md text-lg font-medium" style="display: ${user && !user.isAnonymous ? 'flex' : 'none'};">
                    <img id="navbar-user-icon" src="${user && user.photoURL ? user.photoURL : defaultProfilePic}" alt="User Icon" class="w-8 h-8 rounded-full mr-2 object-cover">
                    <span id="navbar-user-display-name">${user && user.displayName ? user.displayName : 'Loading...'}</span>
                    <span id="navbar-user-id-display" class="text-xs text-gray-500 ml-2">${userHandleDisplay}</span>
                  </a>
                  <a href="user.html" id="navbar-signin-link" class="text-gray-300 hover:text-gray-50 px-3 py-2 rounded-md text-lg font-medium" style="display: ${user && !user.isAnonymous ? 'none' : 'flex'};">Sign In</a>
                  <button id="navbar-signout-btn" class="text-gray-300 hover:text-gray-50 px-3 py-2 rounded-md text-lg font-medium" style="display: ${user && !user.isAnonymous ? 'flex' : 'none'};">Sign Out</button>
                </div>
              </div>
            </nav>
          `;
          navbarPlaceholder.innerHTML = navbarHtml;
          console.log("DEBUG: 'navbar.html' content injected successfully.");

          const signoutButton = document.getElementById('navbar-signout-btn');
          if (signoutButton) {
            signoutButton.addEventListener('click', async () => {
              try {
                await window.auth.signOut();
                console.log("DEBUG: User signed out from navbar.");
                window.location.href = 'user.html'; // Redirect to user.html to show sign-in
              } catch (error) {
                console.error("Error signing out:", error);
              }
            });
          }

          const navbarUserSettingsLink = document.getElementById('navbar-user-settings-link');
          const navbarSigninLink = document.getElementById('navbar-signin-link');
          const navbarUserIcon = document.getElementById('navbar-user-icon');
          const navbarUserDisplayName = document.getElementById('navbar-user-display-name');
          const navbarUserIdDisplay = document.getElementById('navbar-user-id-display');

          if (user && !user.isAnonymous) {
            if (navbarUserSettingsLink) navbarUserSettingsLink.style.display = 'flex';
            if (navbarSigninLink) navbarSigninLink.style.display = 'none';
            if (navbarUserIcon) navbarUserIcon.src = user.photoURL || defaultProfilePic;
            if (navbarUserDisplayName) navbarUserDisplayName.textContent = user.displayName || 'Account';
            if (navbarUserIdDisplay) navbarUserIdDisplay.textContent = user.handle ? `@${user.handle}` : (user.uid ? user.uid.substring(0, 6) : '');
            console.log("DEBUG: Navbar UI updated for logged-in user.");
          } else {
            if (navbarUserSettingsLink) navbarUserSettingsLink.style.display = 'none';
            if (navbarSigninLink) navbarSigninLink.style.display = 'flex';
            if (navbarUserIcon) navbarUserIcon.src = defaultProfilePic;
            if (navbarUserDisplayName) navbarUserDisplayName.textContent = 'Sign In';
            if (navbarUserIdDisplay) navbarUserIdDisplay.textContent = '';
            console.log("DEBUG: Navbar UI updated for logged-out user.");
          }
        } catch (error) {
          console.error("ERROR: Failed to load navigation bar:", error);
          const manualNavbar = `
            <nav class="navbar-bg p-4 shadow-lg w-full">
              <div class="container mx-auto flex justify-between items-center">
                <a href="index.html" class="text-gray-50 text-2xl font-bold">Arcator.co.uk</a>
                <div>
                  <a href="user.html" class="text-gray-300 hover:text-gray-50 px-3 py-2 rounded-md text-lg font-medium">Sign In / Account</a>
                </div>
              </div>
            </nav>
          `;
          if (navbarPlaceholder) navbarPlaceholder.innerHTML = manualNavbar;
          console.log("DEBUG: Fallback manual navbar injected due to error.");
        }
      } else {
        console.error("ERROR: Navbar placeholder element not found.");
      }
    };
  })(); // End Navbar Module

  // ========================================================================
  // Module: User Page Main Logic (Authentication and Settings)
  // Handles display logic, form submissions, and data interactions.
  // Depends on global Firebase, Utils, Themes, and Navbar functions.
  // ========================================================================
  (function() {
    // DOM Elements - Auth sections
    const signInSection = document.getElementById('signin-section');
    const signUpSection = document.getElementById('signup-section');
    const forgotPasswordSection = document.getElementById('forgot-password-section');

    // DOM Elements - Sign In
    const signInEmailInput = document.getElementById('signin-email');
    const signInPasswordInput = document.getElementById('signin-password');
    const signInButton = document.getElementById('signin-btn');
    const goToSignUpLink = document.getElementById('go-to-signup-link');
    const goToForgotPasswordLink = document.getElementById('go-to-forgot-password-link');

    // DOM Elements - Sign Up
    const signUpEmailInput = document.getElementById('signup-email');
    const signUpPasswordInput = document.getElementById('signup-password');
    const signUpConfirmPasswordInput = document.getElementById('signup-confirm-password');
    const signUpDisplayNameInput = document.getElementById('signup-display-name');
    const signUpHandleInput = document.getElementById('signup-handle'); // New handle input
    const signUpButton = document.getElementById('signup-btn');
    const goToSignInLink = document.getElementById('go-to-signin-link');

    // DOM Elements - Forgot Password
    const forgotPasswordEmailInput = document.getElementById('forgot-password-email');
    const resetPasswordButton = document.getElementById('reset-password-btn');
    const goToSignInFromForgotLink = document.getElementById('go-to-signin-from-forgot-link');

    // DOM Elements - Settings
    const profilePictureDisplay = document.getElementById('profile-picture-display');
    const displayNameText = document.getElementById('display-name-text');
    const handleText = document.getElementById('handle-text'); // New handle display element
    const emailText = document.getElementById('email-text');
    const settingsContent = document.getElementById('settings-content');
    const loginRequiredMessage = document.getElementById('login-required-message');
    const loadingSpinner = document.getElementById('loading-spinner');
    const displayNameInput = document.getElementById('display-name-input');
    const handleInput = document.getElementById('handle-input'); // Existing handle input for settings
    const profilePictureUrlInput = document.getElementById('profile-picture-url-input');
    const saveProfileBtn = document.getElementById('save-profile-btn');
    const savePreferencesBtn = document.getElementById('save-preferences-btn');
    const fontSizeSelect = document.getElementById('font-size-select');
    const fontFamilySelect = document.getElementById('font-family-select');
    const backgroundPatternSelect = document.getElementById('background-pattern-select');

    /**
     * Shows a specific section and hides others within the main content area.
     * This is a central control for navigation between auth forms and settings.
     * @param {string} sectionId - The ID of the section to make visible.
     */
    function showSection(sectionId) {
      // Hide all main content sections first
      const sections = [signInSection, signUpSection, forgotPasswordSection, settingsContent, loginRequiredMessage];
      sections.forEach(sec => {
        if (sec) sec.style.display = 'none';
      });

      const sectionToShow = document.getElementById(sectionId);
      if (sectionToShow) {
        sectionToShow.style.display = 'block';
        console.log(`DEBUG: Showing section: ${sectionId}`);

        // Update hero banner based on section
        const heroTitle = document.getElementById('hero-title');
        const heroSubtitle = document.getElementById('hero-subtitle');
        if (heroTitle && heroSubtitle) {
          switch (sectionId) {
            case 'signin-section':
              heroTitle.textContent = 'Welcome Back!';
              heroSubtitle.textContent = 'Sign in to your account.';
              break;
            case 'signup-section':
              heroTitle.textContent = 'Join Arcator.co.uk!';
              heroSubtitle.textContent = 'Create your new account.';
              break;
            case 'forgot-password-section':
              heroTitle.textContent = 'Forgot Your Password?';
              heroSubtitle.textContent = 'Reset it here.';
              break;
            case 'settings-content':
              heroTitle.textContent = 'User Settings';
              heroSubtitle.textContent = 'Personalize your Arcator.co.uk experience.';
              break;
            case 'login-required-message':
              heroTitle.textContent = 'Access Restricted';
              heroSubtitle.textContent = 'Please sign in to continue.';
              break;
            default:
              heroTitle.textContent = 'Welcome';
              heroSubtitle.textContent = 'Manage your account or sign in.';
              break;
          }
        }
      } else {
        console.warn(`Attempted to show unknown section: ${sectionId}`);
      }
      hideLoading();
    }

    /**
     * Shows the loading spinner and hides all content sections.
     */
    function showLoading() {
      if (loadingSpinner) loadingSpinner.style.display = 'flex';
      // Hide all known content sections
      const sections = [signInSection, signUpSection, forgotPasswordSection, settingsContent, loginRequiredMessage];
      sections.forEach(sec => {
        if (sec) sec.style.display = 'none';
      });
      console.log("DEBUG: showLoading - Spinner visible, content hidden.");
    }

    /**
     * Hides the loading spinner. Visibility of content sections is handled by showSection.
     */
    function hideLoading() {
      if (loadingSpinner) loadingSpinner.style.display = 'none';
      console.log("DEBUG: hideLoading - Spinner hidden.");
    }

  // Hand
