<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>User Account - Arcator</title>
    <link href="./master.css" rel="stylesheet">
    <link href="./favicon.png" rel="icon" type="image/png">

    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js" type="module"></script>

    <script src="./firebase-init.js" type="module"></script>
    <script src="./settings-manager.js" type="module"></script>
    <script src="./user-main.js" type="module"></script>
    <style>
        .hero-banner {
            background: url("./creativespawn.png") center/cover no-repeat;
            min-height: 250px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .hero-banner::before {
            content: "";
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1;
        }

        .hero-content {
            z-index: 2;
            text-align: center;
            color: #ffffff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
        }
    </style>
</head>
<body class="antialiased">

<div id="navbar-placeholder">
    <nav class="navbar">
        <div class="container navbar-content">
            <div class="flex items-center gap-4">
                <a class="text-xl font-bold no-underline" href="./index.html">Arcator</a>
                <div class="flex items-center gap-4">
                    <a class="nav-link" href="./index.html">Home</a>
                    <a class="nav-link" href="./games.html">Games</a>
                    <a class="nav-link" href="./forms.html">Forms</a>
                    <a class="nav-link" href="./pages.html">Pages</a>
                    <a class="nav-link" href="./about.html">About</a>
                    <a class="nav-link" href="./mod.html">Admin</a>
                </div>
            </div>
            <div class="flex items-center gap-4" id="user-section">
                <div class="sign-in-prompt">Loadingâ€¦</div>
            </div>
        </div>
    </nav>
</div>

<section class="hero-banner">
    <img alt="Hero" class="hero-image" src="./creativespawn.png">
    <div class="hero-overlay"></div>
    <div class="hero-content">
        <h1>User Profile</h1>
        <p>Manage your account settings and preferences</p>
    </div>
</section>

<main class="container mx-auto px-4 py-8">
    <!-- Authentication and settings sections are rendered by the script below -->
    <div class="hidden" id="auth-section"></div>
    <div class="hidden" id="settings-section"></div>
</main>

<div id="footer-placeholder"></div>

<script type="module">
    import {
        GithubAuthProvider,
        GoogleAuthProvider,
        signInWithEmailAndPassword,
        signInWithPopup
    } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
    import {doc, getDoc, setDoc} from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
    import {auth, db, COLLECTIONS} from "./firebase-init.js";
    import {themeManager} from "./theme-manager.js";
    import {showMessageBox} from "./utils.js";
    import {initializePage, loadFooter} from "./core.js";

    // Minimal inline DOM for auth and settings to avoid large HTML inlined here.
    const authSection = document.getElementById('auth-section');
    const settingsSection = document.getElementById('settings-section');

    authSection.innerHTML = `
      <div class="max-w-md mx-auto bg-secondary rounded-lg shadow-lg p-6">
        <form id="login-form" class="space-y-4">
          <h2 class="text-2xl font-bold mb-4">Sign In</h2>
          <div class="auth-input-field">
            <label for="login-email">Email</label>
            <input autocomplete="email" class="form-input" id="login-email" name="email" required type="email"/>
          </div>
          <div class="auth-input-field">
            <label for="login-password">Password</label>
            <input autocomplete="current-password" class="form-input" id="login-password" name="password" required type="password"/>
          </div>
          <button class="btn-primary w-full" id="login-btn" type="submit">Sign In</button>
          <div class="flex items-center justify-center space-x-4 mt-4">
            <button class="btn-secondary" id="google-signin" type="button">Sign in with Google</button>
            <button class="btn-secondary" id="github-signin" type="button">Sign in with GitHub</button>
          </div>
        </form>
      </div>
    `;

    settingsSection.innerHTML = `
      <div id="settings-shell">
        <!-- Profile settings rendered dynamically -->
        <form id="profile-settings-form" class="settings-card p-4 bg-card rounded-lg shadow-lg">
          <h3 class="text-lg font-semibold mb-3">Profile Settings</h3>
          <label>Display Name</label>
          <input id="display-name-input" class="form-input w-full" />
          <label class="mt-3">Handle</label>
          <input id="handle-input" class="form-input w-full" />
          <label class="mt-3">Email</label>
          <input id="email-input" class="form-input w-full" />
          <div class="mt-4"><button class="btn-primary" id="save-profile-btn">Save Changes</button></div>
        </form>
      </div>
    `;

    function showSection(isSignedIn) {
        if (isSignedIn) {
            authSection.classList.add('hidden');
            settingsSection.classList.remove('hidden');
        } else {
            settingsSection.classList.add('hidden');
            authSection.classList.remove('hidden');
        }
    }

    function setupEventListeners() {
        const loginForm = document.getElementById('login-form');
        const googleSignInBtn = document.getElementById('google-signin');
        const githubSignInBtn = document.getElementById('github-signin');
        const saveProfileBtn = document.getElementById('save-profile-btn');

        loginForm?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showMessageBox('Logged in successfully!');
            } catch (error) {
                console.error('Login error:', error);
                showMessageBox(error.message, true);
            }
        });

        googleSignInBtn?.addEventListener('click', async () => {
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error('Google sign-in error:', error);
                showMessageBox(error.message, true);
            }
        });

        githubSignInBtn?.addEventListener('click', async () => {
            try {
                const provider = new GithubAuthProvider();
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error('GitHub sign-in error:', error);
                showMessageBox(error.message, true);
            }
        });

        saveProfileBtn?.addEventListener('click', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) {
                showMessageBox('Please sign in first', true);
                return;
            }
            const updates = {
                displayName: document.getElementById('display-name-input').value,
                handle: document.getElementById('handle-input').value,
                email: document.getElementById('email-input').value,
                lastUpdated: new Date().toISOString()
            };
            try {
                const userRef = doc(db, COLLECTIONS.USER_PROFILES, user.uid);
                await setDoc(userRef, updates, {merge: true});
                showMessageBox('Profile updated');
            } catch (error) {
                console.error('Error saving profile', error);
                showMessageBox('Failed to save profile', true);
            }
        });
    }

    const init = async () => {
        try {
            await Promise.all([initializePage('users'), themeManager.init()]);
            await loadFooter();
            setupEventListeners();

            auth.onAuthStateChanged(async (user) => {
                showSection(!!user);
                if (user) {
                    try {
                        const userRef = doc(db, COLLECTIONS.USER_PROFILES, user.uid);
                        const userDoc = await getDoc(userRef);
                        const data = userDoc.exists() ? userDoc.data() : {};
                        document.getElementById('display-name-input').value = data.displayName || user.displayName || '';
                        document.getElementById('handle-input').value = data.handle || '';
                        document.getElementById('email-input').value = data.email || user.email || '';
                    } catch (err) {
                        console.error('Error loading profile', err);
                    }
                }
            });
        } catch (error) {
            console.error('Page initialization error:', error);
            showMessageBox('Failed to initialize page', true);
        }
    };

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init().catch(err => console.error(err));
    }
</script>
</body>
</html>