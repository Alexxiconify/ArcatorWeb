<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Admin Panel - Arcator</title>
    <link href="./master.css" rel="stylesheet">
    <link href="./favicon.png" rel="icon" type="image/png">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js" type="module"></script>
</head>
<body class="antialiased">
<div id="navbar-placeholder"></div>

<!-- Loading Spinner -->
<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" id="loading-spinner">
    <div class="animate-spin rounded-full h-32 w-32 border-b-2 border-white"></div>
</div>

<!-- Admin Login Form -->
<div class="container mx-auto px-4 py-8 hidden" id="admin-login-section">
    <div class="max-w-md mx-auto bg-card rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold mb-4">Admin Login</h2>
        <form class="space-y-4" id="admin-login-form">
            <!-- Hidden username field for accessibility -->
            <label for="admin-username">
            </label><input aria-hidden="true"
                           autocomplete="username"
                           class="hidden"
                           id="admin-username"
                           name="username"
                           tabindex="-1"
                           type="text">

            <div class="form-group">
                <label for="admin-email">Email</label>
                <input autocomplete="email"
                       class="form-input"
                       id="admin-email"
                       required
                       type="email">
            </div>

            <div class="form-group">
                <label for="admin-password">Password</label>
                <input autocomplete="current-password"
                       class="form-input"
                       id="admin-password"
                       required
                       type="password">
            </div>

            <button class="btn-primary w-full" type="submit">
                Login as Admin
            </button>
        </form>
        </div>
</div>

<!-- Admin Dashboard -->
<div class="container mx-auto px-4 py-8 hidden" id="admin-dashboard">
    <!-- Admin sections here -->
</div>

<!-- Footer -->
<div id="footer-placeholder"></div>

<script type="module">
    import {auth, db, appId} from './firebase-init.js';
    import {initializePage} from './core.js';
    import {showMessageBox} from './utils.js';
    import {themeManager} from './theme-manager.js';
    import {
        collection,
        doc,
        getDoc,
        getDocs,
        query,
        orderBy
    } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

    // Error handling function
    function handleError(error, context = '') {
        console.error(`${context}:`, error);
        showMessageBox(`Error: ${error.message || 'An unknown error occurred'}`, true);
    }

    async function checkAdminStatus(user) {
        if (!user) return false;
        try {
            const userRef = doc(db, `artifacts/${appId}/public/data/user_profiles`, user.uid);
            const userDoc = await getDoc(userRef);
            return userDoc.exists() && userDoc.data()?.isAdmin === true;
        } catch (error) {
            handleError(error, 'Checking admin status');
            return false;
        }
    }

    async function loadAdminDashboard() {
        try {
            const loadingSpinner = document.getElementById('loading-spinner');
            loadingSpinner.classList.remove('hidden');

            // Load admin data here
            const usersRef = collection(db, `artifacts/${appId}/public/data/user_profiles`);
            const usersQuery = query(usersRef, orderBy('createdAt', 'desc'));
            const usersSnapshot = await getDocs(usersQuery);

            // Update UI with user data
            const dashboard = document.getElementById('admin-dashboard');
            dashboard.innerHTML = `
                    <h1 class="text-3xl font-bold mb-8">Admin Dashboard</h1>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- User Management Card -->
                        <div class="bg-card p-6 rounded-lg shadow-lg">
                            <h2 class="text-xl font-semibold mb-4">User Management</h2>
                            <p class="text-text-secondary mb-4">Total Users: ${usersSnapshot.size}</p>
                            <button onclick="window.location.href='./admin-user-management.html'" class="btn-primary">
                                Manage Users
                            </button>
                        </div>

                        <!-- Theme Management Card -->
                        <div class="bg-card p-6 rounded-lg shadow-lg">
                            <h2 class="text-xl font-semibold mb-4">Theme Management</h2>
                            <button onclick="showThemeModal()" class="btn-primary">
                                Manage Themes
                            </button>
                        </div>

                        <!-- Site Settings Card -->
                        <div class="bg-card p-6 rounded-lg shadow-lg">
                            <h2 class="text-xl font-semibold mb-4">Site Settings</h2>
                            <button onclick="window.location.href='./admin-settings.html'" class="btn-primary">
                                Manage Settings
                            </button>
                        </div>
                    </div>
                `;

            loadingSpinner.classList.add('hidden');
            dashboard.classList.remove('hidden');
        } catch (error) {
            handleError(error, 'Loading admin dashboard');
        }
    }

    // Initialize admin page
    async function initAdmin() {
        try {
            const loginSection = document.getElementById('admin-login-section');
            const dashboard = document.getElementById('admin-dashboard');

            // Initialize page components
            await Promise.all([
                initializePage('admin'),
                themeManager.init()
            ]);

            // Handle auth state changes
            auth.onAuthStateChanged(async (user) => {
                try {
                    if (user) {
                        const isAdmin = await checkAdminStatus(user);
                        if (isAdmin) {
                            loginSection.classList.add('hidden');
                            await loadAdminDashboard();
                        } else {
                            showMessageBox('Access denied. Admin privileges required.', true);
                            window.location.href = './index.html';
                        }
                    } else {
                        dashboard.classList.add('hidden');
                        loginSection.classList.remove('hidden');
                    }
                } catch (error) {
                    handleError(error, 'Auth state change');
                }
            });

            // Handle admin login
            const loginForm = document.getElementById('admin-login-form');
            loginForm?.addEventListener('submit', async (e) => {
                e.preventDefault();
                try {
                    const email = document.getElementById('admin-email').value;
                    const password = document.getElementById('admin-password').value;
                    await auth.signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    handleError(error, 'Admin login');
                }
            });

        } catch (error) {
            handleError(error, 'Initializing admin page');
        }
    }

    // Start initialization when document is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initAdmin);
    } else {
        initAdmin().catch(error => handleError(error, 'Page load'));
    }
</script>
</body>
</html>