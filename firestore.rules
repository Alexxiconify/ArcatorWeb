rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
                                        // Helper
functions
function
isAuthenticated()
{
return request.auth != null;
    }

function
isOwner(userId)
{
return isAuthenticated() & & request.auth.uid == userId;
    }

function
isAdmin()
{
return isAuthenticated() & &
exists( / databases /$(database) / documents / users /$(request.auth.uid)) & &
get( / databases /$(database) / documents / users /$(request.auth.uid)).data.isAdmin == true;
}

// Default
allow
read
match / {document = **} {
      allow read: if true;
allow
write:
if false;
}

// Users
access - override
default
for sensitive data
match / users / {userId} {
// Allow
read
for basic profile info
      allow read: if true;

// Restrict
access
to
sensitive
fields
allow
read:
if resource.data.keys().hasAll(['email', 'phoneNumber', 'privateData']) & &
    (isOwner(userId) | | isAdmin());

allow
write:
if isOwner(userId) | | isAdmin();

match / dms / {dmId}
{
    allow
read, write:
if isAuthenticated() & &
        (isOwner(userId) | |
         resource.data.participants.hasAny([request.auth.uid]));

match / messages / {messageId} {
allow read: if
isAuthenticated() & &
(isOwner(userId) | |
 get( / databases /$(database) / documents / users /$(userId) / dms /$(dmId)).data.participants.hasAny([
    request.auth.uid]));
allow
create:
if isAuthenticated() & &
        request.resource.data.sender == request.auth.uid & &
        get( / databases /$(database) / documents / users / $(userId) / dms / $(dmId)).data.participants.hasAny([request.auth.uid]);
allow update, delete: if
false;
}
}
    }

// Forms
access - override
default
for submissions
match / forms / {formId} {
allow
read:
if true;
allow
write:
if isAdmin();

match / submissions / {submissionId}
{
    allow
read:
if isAdmin() | | isOwner(resource.data.userId);
allow create: if
isAuthenticated();
allow
update, delete:
if false;
}
}

// Admin - only
collections
match / admin / {document = **} {
allow
read, write:
if isAdmin();
}

// Sensitive
data
collections
match / sensitive / {document = **} {
allow
read, write:
if false;
}
  }
}