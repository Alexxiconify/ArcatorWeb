<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin & Dev - Arcator.co.uk</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts - Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <!-- EasyMDE (Markdown Editor) CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde@2.18.0/dist/easymde.min.css">
  <!-- Link to the CSS variables -->
  <link rel="stylesheet" href="theme_variables.css">
  <!-- Link to navbar.css for consistent styling -->
  <link rel="stylesheet" href="navbar.css">
  <!-- Import themes.js for centralized JavaScript functions -->
  <script src="themes.js" type="module"></script>
  <!-- Import custom_theme_modal.js for custom theme management logic -->
  <script src="custom_theme_modal.js" type="module"></script>
  <!-- Import loadNavbar from navbar.js -->
  <script src="navbar.js" type="module"></script>
  <style>
    /* Base styles for the body, applying transitions for smooth theme changes. */
    body {
      font-family: 'Inter', sans-serif;
      transition: background-color 0.3s ease, color 0.3s ease;
      background-color: var(--color-body-bg); /* Use CSS variable for body background */
      color: var(--color-text-primary); /* Use CSS variable for default body text color */
    }

    /* Hero Banner styles - common for all themes, retains background image */
    .hero-banner {
      background-image: url('https://jylina.arcator.co.uk/standalone/img/creativespawn.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      min-height: 250px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }
    .hero-banner::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5); /* Dark overlay for text readability */
      z-index: 1;
    }
    .hero-content {
      position: relative;
      z-index: 2;
      color: white; /* Hero content text is hardcoded white for readability over image */
      text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
    }

    /* Main content section styling using CSS variables */
    .bg-content-section { background-color: var(--color-bg-content-section); }
    .text-heading-main { color: var(--color-heading-main); }
    .text-text-primary { color: var(--color-text-primary); }
    .text-text-secondary { color: var(--color-text-secondary); }
    .bg-card { background-color: var(--color-bg-card); }
    .bg-navbar { background-color: var(--color-bg-navbar); } /* For footer */
    .text-link { color: var(--color-link); }
    .text-link-footer { color: var(--color-text-secondary); } /* Specific for footer links */
    .hover\:text-link:hover { color: var(--color-link); } /* General hover for links */
    .text-heading-card { color: var(--color-heading-card); }

    /* Form and input styling */
    .input-field label {
      color: var(--color-text-secondary);
    }
    .input-field input[type="text"],
    .input-field input[type="url"],
    .input-field select,
    .input-field textarea {
      background-color: var(--color-input-bg) !important;
      color: var(--color-input-text) !important;
      border-color: var(--color-input-border) !important;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
    }
    .input-field input::placeholder,
    .input-field textarea::placeholder {
      color: var(--color-placeholder) !important;
    }

    /* Button styling */
    .btn-primary {
      color: var(--color-button-text);
      font-weight: 700;
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      transition: background-color 0.2s, transform 0.2s;
    }
    .btn-blue {
      background-color: var(--color-button-blue-bg);
    }
    .btn-blue:hover {
      background-color: var(--color-button-blue-hover);
    }
    .btn-green {
      background-color: var(--color-button-green-bg);
    }
    .btn-green:hover {
      background-color: var(--color-button-green-hover);
    }
    .btn-red {
      background-color: var(--color-button-red-bg);
    }
    .btn-red:hover {
      background-color: var(--color-button-red-hover);
    }

    /* Table styling */
    .table-header {
      background-color: var(--color-table-th-bg);
      color: var(--color-table-th-text);
    }
    .table-row-even {
      background-color: var(--color-table-row-even-bg);
    }
    .table-border {
      border-color: var(--color-table-td-border);
    }
    .table-text-primary {
      color: var(--color-text-primary);
    }

    /* Modal styling from custom_theme_modal.js styles */
    .modal {
      background-color: rgba(0,0,0,0.7); /* Consistent with modal background */
    }
    .modal-content {
      background-color: var(--color-modal-bg);
      color: var(--color-modal-text);
    }
    .modal-content label {
      color: var(--color-modal-text);
    }
    .modal-content input[type="text"],
    .modal-content input[type="color"],
    .modal-content select,
    .modal-content textarea {
      background-color: var(--color-modal-input-bg) !important;
      color: var(--color-modal-input-text) !important;
      border-color: var(--color-input-border) !important;
    }
    .modal-content input::placeholder,
    .modal-content textarea::placeholder {
      color: var(--color-placeholder) !important;
    }
  </style>
</head>
<body class="antialiased">
<!-- Navbar Placeholder -->
<div id="navbar-placeholder" class="w-full absolute top-0 left-0"></div>

<!-- Hero Section with Background Image -->
<section class="hero-banner rounded-b-lg shadow-xl" style="margin-top: 64px;"> <!-- Added margin-top to account for fixed navbar height -->
  <div class="container mx-auto px-4 text-center hero-content">
    <h1 class="text-5xl md:text-6xl font-extrabold mb-4 leading-tight">Admin & Development Tools</h1>
    <p class="text-xl md:text-2xl mb-8">Manage Content & Track Progress</p>
  </div>
</section>

<!-- Main Content Section -->
<main class="py-16 bg-content-section rounded-lg shadow-inner mx-4 my-8">
  <div class="container mx-auto px-4">
    <!-- Temporary Page Creation Section -->
    <section class="mb-12 bg-card p-6 rounded-lg shadow-md">
      <h2 class="text-3xl font-bold text-heading-main text-center mb-6">Create Temporary Page</h2>
      <form id="create-temp-page-form" class="space-y-4">
        <div class="input-field">
          <label for="temp-page-title" class="block text-sm font-semibold mb-2">Page Title:</label>
          <input type="text" id="temp-page-title" class="w-full p-2 border rounded" placeholder="Enter page title" required>
        </div>
        <div class="input-field">
          <label for="temp-page-content" class="block text-sm font-semibold mb-2">Page Content (Markdown):</label>
          <textarea id="temp-page-content" class="w-full p-2 border rounded" rows="10" placeholder="Write your markdown content here..."></textarea>
        </div>
        <button type="submit" class="btn-primary btn-blue w-full">Create Page</button>
      </form>
      <div id="temp-page-links" class="mt-8">
        <h3 class="text-2xl font-bold text-heading-card mb-4">Existing Temporary Pages:</h3>
        <div id="temp-page-list" class="space-y-2">
          <p class="text-text-secondary">Loading temporary pages...</p>
        </div>
      </div>
    </section>

    <!-- To-Do List Section -->
    <section class="mb-12 bg-card p-6 rounded-lg shadow-md">
      <h2 class="text-3xl font-bold text-heading-main text-center mb-6">Development To-Do List</h2>
      <form id="add-todo-form" class="space-y-4">
        <div class="input-field">
          <label for="todo-task" class="block text-sm font-semibold mb-2">Task:</label>
          <input type="text" id="todo-task" class="w-full p-2 border rounded" placeholder="e.g., Implement dark mode for forms" required>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="input-field">
            <label for="todo-worker" class="block text-sm font-semibold mb-2">Assigned Worker:</label>
            <input type="text" id="todo-worker" class="w-full p-2 border rounded" placeholder="e.g., John Doe">
          </div>
          <div class="input-field">
            <label for="todo-priority" class="block text-sm font-semibold mb-2">Priority:</label>
            <select id="todo-priority" class="w-full p-2 border rounded">
              <option value="Low">Low</option>
              <option value="Medium">Medium</option>
              <option value="High">High</option>
              <option value="Critical">Critical</option>
            </select>
          </div>
          <div class="input-field">
            <label for="todo-eta" class="block text-sm font-semibold mb-2">ETA:</label>
            <input type="text" id="todo-eta" class="w-full p-2 border rounded" placeholder="e.g., 3 days / Q4 2024">
          </div>
        </div>
        <div class="input-field">
          <label for="todo-notes" class="block text-sm font-semibold mb-2">Notes:</label>
          <textarea id="todo-notes" class="w-full p-2 border rounded" rows="3" placeholder="Additional details..."></textarea>
        </div>
        <button type="submit" class="btn-primary btn-green w-full">Add To-Do Item</button>
      </form>

      <div class="mt-8">
        <h3 class="text-2xl font-bold text-heading-card mb-4">Current To-Do Items:</h3>
        <div id="todo-list" class="space-y-4">
          <p class="text-text-secondary">Loading to-do items...</p>
        </div>
      </div>
    </section>
  </div>
</main>

<!-- Modals for editing and confirmation -->
<!-- Edit To-Do Item Modal -->
<div id="editTodoModal" class="modal fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
  <div class="modal-content bg-card p-6 rounded-lg shadow-lg max-w-lg w-full relative">
    <span class="close-button absolute top-2 right-4 text-xl cursor-pointer">&times;</span>
    <h3 class="text-2xl font-bold text-heading-main mb-4">Edit To-Do Item</h3>
    <form id="edit-todo-form" class="space-y-4">
      <div class="input-field">
        <label for="edit-todo-task" class="block text-sm font-semibold mb-2">Task:</label>
        <input type="text" id="edit-todo-task" class="w-full p-2 border rounded" required>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="input-field">
          <label for="edit-todo-worker" class="block text-sm font-semibold mb-2">Assigned Worker:</label>
          <input type="text" id="edit-todo-worker" class="w-full p-2 border rounded">
        </div>
        <div class="input-field">
          <label for="edit-todo-priority" class="block text-sm font-semibold mb-2">Priority:</label>
          <select id="edit-todo-priority" class="w-full p-2 border rounded">
            <option value="Low">Low</option>
            <option value="Medium">Medium</option>
            <option value="High">High</option>
            <option value="Critical">Critical</option>
          </select>
        </div>
        <div class="input-field">
          <label for="edit-todo-eta" class="block text-sm font-semibold mb-2">ETA:</label>
          <input type="text" id="edit-todo-eta" class="w-full p-2 border rounded">
        </div>
      </div>
      <div class="input-field">
        <label for="edit-todo-notes" class="block text-sm font-semibold mb-2">Notes:</label>
        <textarea id="edit-todo-notes" class="w-full p-2 border rounded" rows="3"></textarea>
      </div>
      <button type="submit" id="save-todo-changes-btn" class="btn-primary btn-blue w-full">Save Changes</button>
    </form>
  </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" class="modal fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
  <div class="modal-content bg-card p-6 rounded-lg shadow-lg max-w-sm w-full text-center relative">
    <p id="confirmMessage" class="text-lg mb-6">Are you sure?</p>
    <button id="confirmYesBtn" class="btn-primary btn-red w-1/2 inline-block">Yes</button>
    <button id="confirmNoBtn" class="btn-primary btn-blue w-1/2 inline-block ml-2">No</button>
  </div>
</div>

<!-- Message Box Element -->
<div id="message-box" class="message-box"></div>


<!-- Footer Section -->
<footer class="bg-navbar py-8 text-center text-text-secondary rounded-t-lg shadow-inner mt-8">
  <div class="container mx-auto px-4">
    <p>© 2012 - <span id="current-year-admin"></span> Arcator.co.uk. All rights reserved.</p>
    <p class="mt-2">Made with ❤️ for the Minecraft Community.</p>
    <div class="flex flex-wrap justify-center space-x-6 mt-4">
      <a href="privacy.html" class="hover:text-link transition duration-300 ease-in-out text-link-footer">Privacy Policy</a>
      <a href="terms.html" class="hover:text-link transition duration-300 ease-in-out text-link-footer">Terms of Service</a>
      <a href="https://wiki.arcator.co.uk/" target="_blank" rel="noopener noreferrer" class="hover:text-link transition duration-300 ease-in-out text-link-footer">Wiki</a>
      <a href="infrastructure.html" class="hover:text-link transition duration-300 ease-in-out text-link-footer">Infrastructure</a>
      <a href="admin_and_dev.html" class="hover:text-link text-heading-card transition duration-300 ease-in-out">Admin & Dev</a>
    </div>
  </div>
</footer>

<!-- EasyMDE (Markdown Editor) JS -->
<script src="https://cdn.jsdelivr.net/npm/easymde@2.18.0/dist/easymde.min.js"></script>
<!-- Firebase SDKs -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import {
    getFirestore,
    collection,
    addDoc,
    getDocs,
    doc,
    deleteDoc,
    query,
    orderBy,
    onSnapshot,
    updateDoc,
    serverTimestamp // Import serverTimestamp
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  import { setupThemesFirebase, applyTheme, getAvailableThemes } from './themes.js';
  import { loadNavbar } from './navbar.js';

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyCP5Zb1CRermAKn7p_S30E8qzCbvsMxhm4",
    authDomain: "arcator-web.firebaseapp.com",
    projectId: "arcator-web",
    storageBucket: "arcator-web.firebasestorage.app",
    messagingSenderId: "1033082068049",
    appId: "1:1033082068049:web:dd154c8b188bde1930ec70",
    measurementId: "G-DJXNT1L7CM"
  };

  const canvasAppId = typeof __app_id !== 'undefined' ? __app_id : null;
  const appId = canvasAppId || firebaseConfig.projectId || 'default-app-id';

  let app;
  let auth;
  let db;
  let isFirebaseInitialized = false;
  let currentEditingTodoId = null; // Store the ID of the todo item being edited
  let currentConfirmAction = null; // Stores the action to perform after confirmation (e.g., 'deleteTempPage', 'deleteTodo')
  let currentConfirmId = null; // Stores the ID related to the current confirmation action

  const DEFAULT_PROFILE_PIC = 'https://placehold.co/32x32/1F2937/E5E7EB?text=AV'; // Default placeholder
  const DEFAULT_THEME_NAME = 'dark'; // Default theme name

  // Initialize Firebase
  try {
    app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    db = getFirestore(app);
    isFirebaseInitialized = true;
    console.log("Firebase initialized successfully in admin_and_dev.html.");
    setupThemesFirebase(db, auth, appId); // Pass auth as well to themes.js setup
  } catch (e) {
    console.error("Error initializing Firebase in admin_and_dev.html:", e);
  }

  // EasyMDE instance for creating temporary pages
  let easyMDECreate;

  // DOM Elements
  const loadingSpinner = document.getElementById('loading-spinner');
  const createTempPageForm = document.getElementById('create-temp-page-form');
  const tempPageTitleInput = document.getElementById('temp-page-title');
  const tempPageContentTextarea = document.getElementById('temp-page-content');
  const tempPageListDiv = document.getElementById('temp-page-list');

  const addTodoForm = document.getElementById('add-todo-form');
  const todoTaskInput = document.getElementById('todo-task');
  const todoWorkerInput = document.getElementById('todo-worker');
  const todoPrioritySelect = document.getElementById('todo-priority');
  const todoEtaInput = document.getElementById('todo-eta');
  const todoNotesInput = document.getElementById('todo-notes');
  const todoListDiv = document.getElementById('todo-list');

  const editTodoModal = document.getElementById('editTodoModal');
  const editTodoCloseButton = editTodoModal ? editTodoModal.querySelector('.close-button') : null;
  const editTodoTaskInput = document.getElementById('edit-todo-task');
  const editTodoWorkerInput = document.getElementById('edit-todo-worker');
  const editTodoPrioritySelect = document.getElementById('edit-todo-priority');
  const editTodoEtaInput = document.getElementById('edit-todo-eta');
  const editTodoNotesInput = document.getElementById('edit-todo-notes');
  const saveTodoChangesBtn = document.getElementById('save-todo-changes-btn');

  const confirmModal = document.getElementById('confirmModal');
  const confirmMessage = document.getElementById('confirmMessage');
  const confirmYesBtn = document.getElementById('confirmYesBtn');
  const confirmNoBtn = document.getElementById('confirmNoBtn');

  const messageBox = document.getElementById('message-box');

  // Utility function to display messages (like alerts, but custom UI)
  function showMessageBox(message, isError = false) {
    messageBox.textContent = message;
    messageBox.className = 'message-box'; // Reset classes
    if (isError) {
      messageBox.classList.add('error');
    } else {
      messageBox.classList.add('success');
    }
    messageBox.style.display = 'block';
    setTimeout(() => {
      messageBox.style.display = 'none';
    }, 5000);
  }

  // --- Temporary Pages Functions ---

  /**
   * Creates a new temporary page document in Firestore.
   * @param {string} title - The title of the page.
   * @param {string} content - The markdown content of the page.
   */
  async function createTempPage(title, content) {
    if (!db || !auth.currentUser) {
      showMessageBox("Please log in to create a temporary page.", true);
      return;
    }
    try {
      await addDoc(collection(db, `artifacts/${appId}/users/${auth.currentUser.uid}/temporary_pages`), {
        title: title,
        content: content,
        createdAt: serverTimestamp(),
        createdBy: auth.currentUser.uid,
        lastModified: serverTimestamp()
      });
      showMessageBox("Temporary page created successfully!", false);
      easyMDECreate.value(""); // Clear the editor
      tempPageTitleInput.value = ""; // Clear the title input
    } catch (e) {
      console.error("Error adding document: ", e);
      showMessageBox("Error creating page: " + e.message, true);
    }
  }

  /**
   * Deletes a temporary page from Firestore.
   * @param {string} pageId - The ID of the page to delete.
   */
  async function deleteTempPage(pageId) {
    if (!db || !auth.currentUser) {
      showMessageBox("Please log in to delete pages.", true);
      return;
    }
    try {
      await deleteDoc(doc(db, `artifacts/${appId}/users/${auth.currentUser.uid}/temporary_pages`, pageId));
      showMessageBox("Temporary page deleted successfully!", false);
    } catch (e) {
      console.error("Error deleting document: ", e);
      showMessageBox("Error deleting page: " + e.message, true);
    }
  }

  /**
   * Renders the list of temporary pages and sets up real-time listener.
   */
  function renderTempPages() {
    if (!db || !auth.currentUser) {
      tempPageListDiv.innerHTML = '<p class="text-text-secondary">Please log in to view temporary pages.</p>';
      return;
    }

    const q = query(collection(db, `artifacts/${appId}/users/${auth.currentUser.uid}/temporary_pages`), orderBy("createdAt", "desc"));

    onSnapshot(q, (snapshot) => {
      if (tempPageListDiv) {
        tempPageListDiv.innerHTML = ''; // Clear current list
        if (snapshot.empty) {
          tempPageListDiv.innerHTML = '<p class="text-text-secondary">No temporary pages created yet.</p>';
          return;
        }

        snapshot.forEach((doc) => {
          const page = doc.data();
          const pageId = doc.id;
          const pageElement = document.createElement('div');
          pageElement.className = 'flex justify-between items-center bg-gray-700 p-3 rounded-md shadow-sm mb-2 text-table-text-primary';
          pageElement.innerHTML = `
            <span>${page.title}</span>
            <div>
              <a href="temp_page.html?id=${pageId}" target="_blank" class="text-link hover:underline mr-4">View</a>
              <button data-id="${pageId}" class="delete-temp-page-btn btn-red text-white py-1 px-3 rounded-md text-sm">Delete</button>
            </div>
          `;
          tempPageListDiv.appendChild(pageElement);
        });

        // Attach event listeners to delete buttons
        tempPageListDiv.querySelectorAll('.delete-temp-page-btn').forEach(button => {
          button.addEventListener('click', (e) => {
            currentConfirmAction = 'deleteTempPage';
            currentConfirmId = e.target.dataset.id;
            confirmMessage.textContent = 'Are you sure you want to delete this temporary page?';
            confirmModal.classList.remove('hidden');
          });
        });
      }
    }, (error) => {
      console.error("Error fetching temporary pages:", error);
      tempPageListDiv.innerHTML = `<p class="text-red-500">Error loading pages: ${error.message}</p>`;
    });
  }

  // --- To-Do List Functions ---

  /**
   * Adds a new todo item to Firestore.
   */
  async function addTodoItem(task, worker, priority, eta, notes) {
    if (!db || !auth.currentUser) {
      showMessageBox("Please log in to add a to-do item.", true);
      return;
    }
    try {
      await addDoc(collection(db, `artifacts/${appId}/users/${auth.currentUser.uid}/todo_items`), {
        task: task,
        worker: worker,
        priority: priority,
        eta: eta,
        notes: notes,
        completed: false,
        createdAt: serverTimestamp(),
        lastModified: serverTimestamp()
      });
      showMessageBox("To-do item added successfully!", false);
      addTodoForm.reset(); // Clear form
    } catch (e) {
      console.error("Error adding todo item: ", e);
      showMessageBox("Error adding to-do item: " + e.message, true);
    }
  }

  /**
   * Updates an existing todo item in Firestore.
   * @param {string} todoId - The ID of the todo item to update.
   * @param {string} task - The task description.
   * @param {string} worker - Assigned worker.
   * @param {string} priority - Task priority.
   * @param {string} eta - Estimated time of arrival.
   * @param {string} notes - Additional notes.
   */
  async function updateTodoItem(todoId, task, worker, priority, eta, notes) {
    if (!db || !auth.currentUser) {
      showMessageBox("Please log in to update to-do items.", true);
      return;
    }
    try {
      const todoRef = doc(db, `artifacts/${appId}/users/${auth.currentUser.uid}/todo_items`, todoId);
      await updateDoc(todoRef, {
        task: task,
        worker: worker,
        priority: priority,
        eta: eta,
        notes: notes,
        lastModified: serverTimestamp()
      });
      showMessageBox("To-do item updated successfully!", false);
      editTodoModal.classList.add('hidden'); // Hide modal after saving
      currentEditingTodoId = null; // Clear editing state
    } catch (e) {
      console.error("Error updating todo item: ", e);
      showMessageBox("Error updating to-do item: " + e.message, true);
    }
  }

  /**
   * Deletes a todo item from Firestore.
   * @param {string} todoId - The ID of the todo item to delete.
   */
  async function deleteTodoItem(todoId) {
    if (!db || !auth.currentUser) {
      showMessageBox("Please log in to delete to-do items.", true);
      return;
    }
    try {
      await deleteDoc(doc(db, `artifacts/${appId}/users/${auth.currentUser.uid}/todo_items`, todoId));
      showMessageBox("To-do item deleted successfully!", false);
    } catch (e) {
      console.error("Error deleting todo item: ", e);
      showMessageBox("Error deleting to-do item: " + e.message, true);
    }
  }

  /**
   * Toggles the completion status of a todo item.
   * @param {string} todoId - The ID of the todo item.
   * @param {boolean} currentStatus - The current completion status.
   */
  async function toggleTodoCompletion(todoId, currentStatus) {
    if (!db || !auth.currentUser) {
      showMessageBox("Please log in to update to-do items.", true);
      return;
    }
    try {
      const todoRef = doc(db, `artifacts/${appId}/users/${auth.currentUser.uid}/todo_items`, todoId);
      await updateDoc(todoRef, {
        completed: !currentStatus,
        lastModified: serverTimestamp()
      });
      showMessageBox("To-do item status updated!", false);
    } catch (e) {
      console.error("Error toggling todo completion: ", e);
      showMessageBox("Error updating status: " + e.message, true);
    }
  }

  /**
   * Renders the list of todo items and sets up real-time listener.
   */
  function renderTodoItems() {
    if (!db || !auth.currentUser) {
      todoListDiv.innerHTML = '<p class="text-text-secondary">Please log in to view to-do items.</p>';
      return;
    }

    const q = query(collection(db, `artifacts/${appId}/users/${auth.currentUser.uid}/todo_items`), orderBy("createdAt", "desc"));

    onSnapshot(q, (snapshot) => {
      if (todoListDiv) {
        todoListDiv.innerHTML = ''; // Clear current list
        if (snapshot.empty) {
          todoListDiv.innerHTML = '<p class="text-text-secondary">No to-do items yet. Add one above!</p>';
          return;
        }

        snapshot.forEach((doc) => {
          const todo = { id: doc.id, ...doc.data() };
          const todoElement = document.createElement('div');
          todoElement.className = `bg-gray-700 p-4 rounded-lg shadow-md flex flex-col md:flex-row items-start md:items-center justify-between mb-4 ${todo.completed ? 'opacity-60 line-through' : ''} text-table-text-primary`;
          todoElement.innerHTML = `
            <div class="flex-1 mb-2 md:mb-0">
              <h4 class="text-lg font-semibold">${todo.task}</h4>
              <p class="text-sm text-text-secondary">Worker: ${todo.worker || 'N/A'}</p>
              <p class="text-sm text-text-secondary">Priority: ${todo.priority || 'N/A'}</p>
              <p class="text-sm text-text-secondary">ETA: ${todo.eta || 'N/A'}</p>
              <p class="text-sm text-text-secondary">Notes: ${todo.notes || 'None'}</p>
            </div>
            <div class="flex items-center space-x-2">
              <input type="checkbox" data-id="${todo.id}" class="todo-checkbox w-5 h-5" ${todo.completed ? 'checked' : ''}>
              <button data-id="${todo.id}"
                      data-task="${todo.task}"
                      data-worker="${todo.worker || ''}"
                      data-priority="${todo.priority || 'Low'}"
                      data-eta="${todo.eta || ''}"
                      data-notes="${todo.notes || ''}"
                      class="edit-todo-btn btn-blue text-white py-1 px-3 rounded-md text-sm">Edit</button>
              <button data-id="${todo.id}" class="delete-todo-btn btn-red text-white py-1 px-3 rounded-md text-sm">Delete</button>
            </div>
          `;
          todoListDiv.appendChild(todoElement);
        });

        // Attach event listeners for checkboxes
        todoListDiv.querySelectorAll('.todo-checkbox').forEach(checkbox => {
          checkbox.addEventListener('change', (e) => {
            const todoId = e.target.dataset.id;
            const isCompleted = e.target.checked;
            toggleTodoCompletion(todoId, !isCompleted); // Pass current status, toggle it for the update
          });
        });

        // Attach event listeners for edit buttons
        todoListDiv.querySelectorAll('.edit-todo-btn').forEach(button => {
          button.addEventListener('click', (e) => {
            currentEditingTodoId = e.target.dataset.id;
            editTodoTaskInput.value = e.target.dataset.task;
            editTodoWorkerInput.value = e.target.dataset.worker;
            editTodoPrioritySelect.value = e.target.dataset.priority;
            editTodoEtaInput.value = e.target.dataset.eta;
            editTodoNotesInput.value = e.target.dataset.notes;
            editTodoModal.classList.remove('hidden');
          });
        });

        // Attach event listeners for delete buttons
        todoListDiv.querySelectorAll('.delete-todo-btn').forEach(button => {
          button.addEventListener('click', (e) => {
            currentConfirmAction = 'deleteTodo';
            currentConfirmId = e.target.dataset.id;
            confirmMessage.textContent = 'Are you sure you want to delete this to-do item?';
            confirmModal.classList.remove('hidden');
          });
        });
      }
    }, (error) => {
      console.error("Error fetching todo items:", error);
      todoListDiv.innerHTML = `<p class="text-red-500">Error loading to-do items: ${error.message}</p>`;
    });
  }

  // --- Modal Logic ---

  // Close modals when clicking the 'x'
  if (editTodoCloseButton) {
    editTodoCloseButton.addEventListener('click', () => {
      editTodoModal.classList.add('hidden');
      currentEditingTodoId = null; // Clear editing state
    });
  }

  // Close modals when clicking outside content
  window.addEventListener('click', (event) => {
    if (event.target === editTodoModal) {
      editTodoModal.classList.add('hidden');
      currentEditingTodoId = null; // Clear editing state
    }
    if (event.target === confirmModal) {
      confirmModal.classList.add('hidden');
      currentConfirmAction = null;
      currentConfirmId = null;
    }
  });

  // Confirmation Modal buttons
  if (confirmYesBtn) {
    confirmYesBtn.addEventListener('click', async () => {
      if (currentConfirmAction === 'deleteTempPage' && currentConfirmId) {
        await deleteTempPage(currentConfirmId);
      } else if (currentConfirmAction === 'deleteTodo' && currentConfirmId) {
        await deleteTodoItem(currentConfirmId);
      }
      confirmModal.classList.add('hidden');
      currentConfirmAction = null;
      currentConfirmId = null;
    });
  }

  if (confirmNoBtn) {
    confirmNoBtn.addEventListener('click', () => {
      confirmModal.classList.add('hidden');
      currentConfirmAction = null;
      currentConfirmId = null;
    });
  }

  // --- Initialization ---

  document.addEventListener('DOMContentLoaded', async () => {
    // Set current year for footer
    document.getElementById('current-year-admin').textContent = new Date().getFullYear();

    // Initialize EasyMDE for temp page content
    easyMDECreate = new EasyMDE({
      element: tempPageContentTextarea,
      spellChecker: false,
      hideIcons: ["guide", "fullscreen", "side-by-side"],
      showIcons: ["heading", "bold", "italic", "strikethrough", "code", "quote", "unordered-list", "ordered-list", "link", "image", "table", "horizontal-rule"],
      initialValue: "### Your temporary page content goes here...\n\n- Use **Markdown** for formatting.\n- This page is visible only to you."
    });

    // Event Listeners for Forms
    if (createTempPageForm) {
      createTempPageForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const title = tempPageTitleInput.value.trim();
        const content = easyMDECreate.value().trim(); // Get content from EasyMDE
        if (!title || !content) {
          showMessageBox("Please enter both title and content for the temporary page.", true);
          return;
        }
        await createTempPage(title, content);
      });
    }

    if (addTodoForm) {
      addTodoForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const task = todoTaskInput.value.trim();
        const worker = todoWorkerInput.value.trim();
        const priority = todoPrioritySelect.value;
        const eta = todoEtaInput.value.trim();
        const notes = todoNotesInput.value.trim();

        if (!task) {
          showMessageBox("Task description is required.", true);
          return;
        }
        await addTodoItem(task, worker, priority, eta, notes);
      });
    }

    if (saveTodoChangesBtn) {
      saveTodoChangesBtn.addEventListener('click', async () => {
        if (!currentEditingTodoId) {
          showMessageBox("No to-do item selected for editing.", true);
          return;
        }
        const task = editTodoTaskInput.value.trim();
        const worker = editTodoWorkerInput.value.trim();
        const priority = editTodoPrioritySelect.value;
        const eta = editTodoEtaInput.value.trim();
        const notes = editTodoNotesInput.value.trim();

        if (!task) {
          showMessageBox("Task description is required.", true);
          return;
        }
        await updateTodoItem(currentEditingTodoId, task, worker, priority, eta, notes);
      });
    }


    // Handle Firebase authentication and data loading
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        console.log("User logged in on Admin & Dev page:", user.uid);
        // Ensure anonymous sign-in for Canvas environment if no initial token
        if (typeof __initial_auth_token !== 'undefined' && user.isAnonymous) {
          try {
            await signInWithCustomToken(auth, __initial_auth_token);
            console.log("Signed in with custom token from Canvas.");
          } catch (error) {
            console.error("Custom token sign-in failed on Admin & Dev:", error);
            // Fallback to anonymous if custom token fails (though already anonymous)
          }
        }
        loadingSpinner.classList.add('hidden');
        renderTempPages(); // Start listening to temp pages
        renderTodoItems(); // Start listening to todo items
        // Apply theme for authenticated user
        const userProfile = await window.getUserProfileFromFirestore(user.uid); // Assuming getUserProfileFromFirestore is globally available from settings.html/themes.js
        const userThemePreference = userProfile?.themePreference;
        const allThemes = await getAvailableThemes();
        const themeToApply = allThemes.find(t => t.id === userThemePreference) || allThemes.find(t => t.id === DEFAULT_THEME_NAME);
        applyTheme(themeToApply.id, themeToApply);

      } else {
        console.log("No user on Admin & Dev page. Attempting anonymous sign-in...");
        // If no user is logged in, attempt anonymous sign-in in Canvas environment
        if (typeof __initial_auth_token !== 'undefined') {
          try {
            await signInAnonymously(auth);
            console.log("Signed in anonymously on Admin & Dev page.");
            loadingSpinner.classList.add('hidden');
            renderTempPages(); // Render for anonymous user (will be empty unless public data)
            renderTodoItems(); // Render for anonymous user (will be empty unless public data)
            applyTheme(DEFAULT_THEME_NAME); // Apply default theme for anonymous user
          } catch (error) {
            console.error("Anonymous sign-in failed on Admin & Dev page:", error);
            loadingSpinner.classList.add('hidden');
            showMessageBox("Could not sign in automatically. Please log in manually for full functionality.", true);
            applyTheme(DEFAULT_THEME_NAME); // Fallback to default theme
          }
        } else {
          // Not in Canvas environment or __initial_auth_token not defined, simply apply default theme
          loadingSpinner.classList.add('hidden');
          showMessageBox("Please log in for full functionality.", true);
          applyTheme(DEFAULT_THEME_NAME);
        }
      }
    });

    // Load navbar after Firebase init and auth state
    // Pass the necessary Firebase instances and theme-related functions
    await loadNavbar({ auth, db, appId }, DEFAULT_PROFILE_PIC, DEFAULT_THEME_NAME);
  });
</script>
</body>
</html>
