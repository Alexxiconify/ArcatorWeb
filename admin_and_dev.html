<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin & Dev - Arcator.co.uk</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts - Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* Base styles for the body, applying a dark background, light text,
     * and a subtle diagonal gradient for texture. */
    body {
      font-family: 'Inter', sans-serif;
      background-color: #1F2937;
      color: #E5E7EB;
      background-image: linear-gradient(45deg, rgba(0,0,0,0.1) 25%, transparent 25%, transparent 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1) 75%, transparent 75%, transparent);
      background-size: 20px 20px;
      background-attachment: fixed;
    }
    /* Styles for the hero banner section, including a background image,
     * sizing, positioning, and a dark overlay for text readability. */
    .hero-banner {
      background-image: url('https://jylina.arcator.co.uk/standalone/img/creativespawn.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      min-height: 250px; /* Ensures the banner has a minimum height */
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative; /* Needed for the pseudo-element overlay */
      overflow: hidden; /* Hides any overflow from the background image */
    }
    /* Pseudo-element for the dark overlay on the hero banner,
     * ensuring text readability over the background image. */
    .hero-banner::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1;
    }
    /* Styles for the content within the hero banner,
     * positioning it above the overlay and applying text shadow. */
    .hero-content {
      position: relative;
      z-index: 2;
      color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
    }
    /* Basic table styling for full width and collapsed borders. */
    table {
      width: 100%;
      border-collapse: collapse;
    }
    /* Styles for table headers and data cells, including padding,
     * text alignment, and bottom border. */
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #374151; /* Darker border for table rows */
    }
    /* Styles specifically for table headers, including background color,
     * text color, font weight, and text transformation. */
    th {
      background-color: #374151; /* Darker header background */
      color: #F87171; /* Red text for headers */
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    /* Alternating background color for even table rows for better readability. */
    tr:nth-child(even) {
      background-color: #2F3B4E; /* Slightly different background for even rows */
    }
    /* Hover effect for table rows, changing background color on mouse-over. */
    tr:hover {
      background-color: #4B5563; /* Lighter background on hover */
    }
    /* Styling for code blocks, including background, padding, border-radius,
     * font family, and overflow properties for better code display. */
    .code-block {
      background-color: #2D3748;
      padding: 1rem;
      border-radius: 0.5rem;
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
      overflow-x: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }
  </style>
</head>
<body class="antialiased">
<!-- Navigation Bar Placeholder -->
<div id="navbar-placeholder"></div>

<!-- Hero Section with Background Image -->
<section class="hero-banner rounded-b-lg shadow-xl">
  <div class="container mx-auto px-4 text-center hero-content">
    <h1 class="text-5xl md:text-6xl font-extrabold mb-4 leading-tight">Administration & Development</h1>
    <p class="text-xl md:text-2xl mb-8">Insights into Arcator's operations and ongoing projects.</p>
  </div>
</section>

<!-- Admin & Dev Section Content -->
<section id="admin-dev" class="py-16 bg-gray-800 rounded-lg shadow-inner mx-4 my-8">
  <div class="container mx-auto px-4">
    <h2 class="text-4xl font-bold text-center mb-12 text-red-400">Our Development Roadmap (Todo List)</h2>>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-12 mt-16">
      <!-- Darrion API Section -->
      <div>
        <h3 class="text-3xl font-bold mb-6 text-red-300">Darrion API</h3>
        <p class="text-lg leading-relaxed text-gray-300 mb-4">The Darrion API provides programmatic access to various Arcator service data. This allows for external tools and integrations to fetch information about our servers and services.</p>
        <h4 class="text-2xl font-semibold mb-4 text-red-200">REST API Endpoints:</h4>
        <ul class="list-disc list-inside text-gray-300 space-y-2">
          <li><span class="font-semibold text-white">GET mc.arcator.co.uk/players</span>: Gets a list of all servers and the players online.</li>
          <li><span class="font-semibold text-white">GET mc.arcator.co.uk/players/:serverName</span>: Gets a list of players on a specific gamemode.</li>
          <li><span class="font-semibold text-white">GET mc.arcator.co.uk/services</span>: Gets the online services on the machines.</li>
          <li><span class="font-semibold text-white">GET plugin updates</span></li>
        </ul>
      </div>

      <!-- GriefDetection Section -->
      <div>
        <h3 class="text-3xl font-bold mb-6 text-red-300">Grief Detection</h3>
        <p class="text-lg leading-relaxed text-gray-300 mb-4">Our automated grief detection system performs regular checks to ensure fair gameplay and a positive environment for all. It prioritizes analysis based on player activity patterns.</p>
        <ul class="list-disc list-inside text-gray-300 space-y-2">
          <li>Regular checks for griefs and automated analysis of player actions.</li>
          <li>Prioritizes players with smaller `lastlog` + `firstlog` differences for analysis (lower playtime players checked first).</li>
          <li>Analyzes player actions using CoreProtectAPI (compares block placements vs. removals).</li>
          <!-- Added rel="noopener noreferrer" for security when opening external links -->
          <li>Includes `AutoWarn` system to log and optionally deny problematic block placements. (<a href="https://github.com/Alexxiconify/AlexxAutoWarn" target="_blank" rel="noopener noreferrer" class="text-blue-300 hover:underline">GitHub Link</a>)</li>
          <li>Statistical analysis of player activity (placed & removed blocks, materials) for future flags.</li>
        </ul>
      </div>
    </div>

    <!-- Onfim Notifications Section -->
    <div class="mt-16">
      <h3 class="text-3xl font-bold mb-6 text-red-300">Onfim Notifications</h3>
      <p class="text-lg leading-relaxed text-gray-300 mb-4">Onfim Notifications are an automated system designed to alert staff via Discord about critical system statuses and potential issues, ensuring quick responses and minimal downtime.</p>
      <ul class="list-disc list-inside text-gray-300 space-y-2">
        <li>Warns staff on Discord when disk space is nearly full.</li>
        <li>Detects and alerts on drive corruption.</li>
        <li>Notifies if core services (Vulcan or Jylina) are not responding.</li>
        <li>Alerts when Jylina's Ngrok IP address changes.</li>
        <li>Handles `#machine-status` updates every minute.</li>
      </ul>
    </div>
  </div>
</section>

<!-- Footer Section -->
<footer class="bg-gray-900 py-8 text-center text-gray-400 rounded-t-lg shadow-inner mt-8">
  <div class="container mx-auto px-4">
    <p>© 2012 - <span id="current-year-admin-dev"></span> Arcator.co.uk. All rights reserved.</p>
    <p class="mt-2">Made with ❤️ for the Minecraft Community.</p>
    <div class="flex flex-wrap justify-center space-x-6 mt-4">
      <a href="#" class="hover:text-white transition duration-300 ease-in-out">Privacy Policy</a>
      <a href="#" class="hover:text-white transition duration-300 ease-in-out">Terms of Service</a>
      <!-- Added rel="noopener noreferrer" for security when opening external links -->
      <a href="https://wiki.arcator.co.uk/" target="_blank" rel="noopener noreferrer" class="hover:text-white transition duration-300 ease-in-out">Wiki</a>
      <a href="infrastructure.html" class="hover:text-white transition duration-300 ease-in-out">Infrastructure</a>
      <a href="admin_and_dev.html" class="hover:text-white transition duration-300 ease-in-out">Admin & Dev</a>
    </div>
  </div>
</footer>

<!-- Message Box Element -->
<div id="message-box" class="message-box" style="display: none;"></div>

<!-- Firebase SDKs -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    signOut,
    signInWithCustomToken,
    signInAnonymously
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import {
    getFirestore,
    doc,
    getDoc
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // Function to load the navigation bar
  async function loadNavbar() {
    try {
      const response = await fetch('navbar.html');
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      const navbarHtml = await response.text();
      document.getElementById('navbar-placeholder').innerHTML = navbarHtml;
    } catch (error) {
      console.error("Failed to load navigation bar:", error);
    }
  }

  // Load navbar when the page loads
  window.onload = function() {
    loadNavbar();
    // Get current year for footer
    document.getElementById('current-year-admin-dev').textContent = new Date().getFullYear();
  };

  // Firebase configuration object
  const firebaseConfig = {
    apiKey: "AIzaSyCP5Zb1CRermAKn7p_S30E8qzCbvsMxhm4",
    authDomain: "arcator-web.firebaseapp.com",
    projectId: "arcator-web",
    storageBucket: "arcator-web.firebasestorage.app",
    messagingSenderId: "1033082068049",
    appId: "1:1033082068049:web:dd154c8b188bde1930ec70",
    measurementId: "G-DJXNT1L7CM"
  };

  // Ensure global __app_id and __initial_auth_token are accessible
  const canvasAppId = typeof __app_id !== 'undefined' ? __app_id : null;
  const canvasInitialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

  // Determine appId for Firestore path - prioritize Canvas provided, then project ID
  const appId = canvasAppId || firebaseConfig.projectId || 'default-app-id';
  const initialAuthToken = canvasInitialAuthToken;

  // Initialize Firebase App, Auth, and Firestore instances
  let app;
  let auth;
  let db;
  let isFirebaseInitialized = false;

  try {
    app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    db = getFirestore(app);
    isFirebaseInitialized = true;
    console.log("Firebase initialized successfully.");
  } catch (e) {
    console.error("Error initializing Firebase:", e);
    showMessageBox("Error initializing Firebase. Cannot perform authentication.", true);
  }

  // DOM elements
  const loadingSpinner = document.getElementById('loading-spinner');
  const loginRequiredMessage = document.getElementById('login-required-message');
  const adminContent = document.getElementById('admin-content');
  const logoutBtn = document.getElementById('logout-btn');
  const adminUserDisplay = document.getElementById('admin-user-display');
  const messageBox = document.getElementById('message-box');

  // Default theme (dark) for styling application
  const DEFAULT_THEME = 'dark';

  /**
   * Displays a custom message box for user feedback.
   * @param {string} message - The message to display.
   * @param {boolean} isError - True for error, false for success.
   */
  function showMessageBox(message, isError) {
    messageBox.textContent = message;
    messageBox.className = 'message-box'; // Reset classes
    if (isError) {
      messageBox.classList.add('error');
    } else {
      messageBox.classList.add('success');
    }
    messageBox.style.display = 'block';
    setTimeout(() => {
      messageBox.style.display = 'none';
    }, 5000); // Hide after 5 seconds
  }

  /**
   * Fetches user profile data from Firestore.
   * @param {string} uid - The user's UID.
   * @returns {Promise<Object|null>} - User profile data or null if not found.
   */
  async function getUserProfileFromFirestore(uid) {
    if (!db) return null;
    const userDocRef = doc(db, `artifacts/${appId}/public/data/user_profiles`, uid);
    try {
      const docSnap = await getDoc(userDocRef);
      if (docSnap.exists()) {
        return docSnap.data();
      }
    } catch (error) {
      console.error("Error fetching user profile from Firestore:", error);
    }
    return null;
  }

  /**
   * Applies the selected theme to the body element.
   * @param {string} theme - 'dark' or 'light'.
   */
  function applyTheme(theme) {
    const body = document.body;
    body.classList.remove('theme-dark', 'theme-light');
    if (theme === 'light') {
      body.classList.add('theme-light');
    } else {
      body.classList.add('theme-dark');
    }
  }


  /**
   * Updates the UI based on the user's authentication and admin status.
   * @param {Object|null} user - The Firebase User object or null.
   */
  async function updateAdminUI(user) {
    loadingSpinner.style.display = 'none'; // Hide spinner once auth state is determined

    if (user) {
      // Fetch user profile to get theme preference
      const userProfile = await getUserProfileFromFirestore(user.uid);
      const themePreference = userProfile?.themePreference || DEFAULT_THEME;
      applyTheme(themePreference);

      // Check if user is a whitelisted admin
      const adminDocRef = doc(db, `artifacts/${appId}/public/data/whitelisted_admins`, user.uid);
      try {
        const adminDocSnap = await getDoc(adminDocRef);
        if (adminDocSnap.exists()) {
          // User is an admin
          loginRequiredMessage.style.display = 'none';
          adminContent.style.display = 'block';
          adminUserDisplay.textContent = userProfile?.displayName || user.displayName || user.email || user.uid; // Display user info
          console.log("Admin user logged in:", user.uid);
        } else {
          // User is logged in but not an admin
          loginRequiredMessage.style.display = 'block';
          adminContent.style.display = 'none';
          showMessageBox("You are logged in, but do not have admin privileges.", true);
          console.log("Regular user logged in, no admin access:", user.uid);
        }
      } catch (error) {
        console.error("Error checking admin whitelist:", error);
        loginRequiredMessage.style.display = 'block';
        adminContent.style.display = 'none';
        showMessageBox("Error checking admin status. Please try again.", true);
      }
    } else {
      // No user is logged in
      loginRequiredMessage.style.display = 'block';
      adminContent.style.display = 'none';
      console.log("No user logged in.");
      applyTheme(DEFAULT_THEME); // Apply default theme if no user
    }
  }

  // Set up Firebase Authentication listener
  if (isFirebaseInitialized && auth) {
    onAuthStateChanged(auth, (user) => {
      updateAdminUI(user);
    });

    // Handle initial custom token sign-in for Canvas environment only if no user already authenticated
    if (initialAuthToken && !auth.currentUser) {
      signInWithCustomToken(auth, initialAuthToken)
        .then(() => {
          console.log("Signed in with custom token from Canvas (admin_dev page).");
        })
        .catch((error) => {
          console.error("Error signing in with custom token (admin_dev page):", error);
          // Fallback to anonymous sign-in if custom token fails (e.g., expired)
          signInAnonymously(auth)
            .then(() => console.log("Signed in anonymously (admin_dev page)."))
            .catch((anonError) => console.error("Error signing in anonymously (admin_dev page):", anonError));
        });
    } else if (!auth.currentUser) {
      // If no custom token and no current user, sign in anonymously by default
      signInAnonymously(auth)
        .then(() => console.log("Signed in anonymously (no custom token) on admin_dev page."))
        .catch((anonError) => console.error("Error signing in anonymously (admin_dev page):", anonError));
    }
  }

  // Event Listener for Logout Button
  if (logoutBtn) {
    logoutBtn.addEventListener('click', async () => {
      showMessageBox("", false); // Clear any existing messages
      try {
        await signOut(auth);
        console.log("User signed out.");
        showMessageBox("You have been signed out.", false);
        // updateAdminUI will be called by onAuthStateChanged
      } catch (error) {
        console.error("Logout failed:", error);
        showMessageBox("Logout failed. Please try again. Error: " + (error.message || "Unknown error"), true);
      }
    });
  }
</script>
</body>
</html>
