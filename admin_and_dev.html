import { setupThemesFirebase, applyTheme, getAvailableThemes } from './themes.js';
import { loadNavbar } from './navbar.js';
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import {
getAuth,
onAuthStateChanged,
signOut,
signInWithCustomToken,
signInAnonymously
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import {
getFirestore,
doc,
getDoc,
setDoc,
collection,
getDocs,
deleteDoc,
addDoc,
updateDoc,
query,
orderBy
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


// Firebase configuration object
const firebaseConfig = {
apiKey: "AIzaSyCP5Zb1CRermAKn7p_S30E8qzCbvsMxhm4",
authDomain: "arcator-web.firebaseapp.com",
projectId: "arcator-web",
storageBucket: "arcator-web.firebasestorage.app",
messagingSenderId: "1033082068049",
appId: "1:1033082068049:web:dd154c8b188bde1930ec70",
measurementId: "G-DJXNT1L7CM"
};

const canvasAppId = typeof __app_id !== 'undefined' ? __app_id : null;
const appId = canvasAppId || firebaseConfig.projectId || 'default-app-id';

let app;
let auth;
let db;
let firebaseReadyPromise; // Promise to ensure Firebase is fully initialized and authenticated
let isFirebaseInitialized = false;

// DOM elements - Initialize immediately after declaration
const loadingSpinner = document.getElementById('loading-spinner');
const loginRequiredMessage = document.getElementById('login-required-message');
const adminContent = document.getElementById('admin-content');
const logoutBtn = document.getElementById('logout-btn');
const adminUserDisplay = document.getElementById('admin-user-display');
const messageBox = document.getElementById('message-box');
const customConfirmModal = document.getElementById('custom-confirm-modal');
const confirmMessage = document.getElementById('confirm-message');
const confirmSubmessage = document.getElementById('confirm-submessage');
const confirmYesBtn = document.getElementById('confirm-yes');
const confirmNoBtn = document.getElementById('confirm-no');


// User Management DOM elements
const loadUsersBtn = document.getElementById('load-users-btn');
const userListTbody = document.getElementById('user-list-tbody');
const editUserModal = document.getElementById('edit-user-modal');
const editUserDisplayNameInput = document.getElementById('edit-user-display-name');
const editUserThemeSelect = document.getElementById('edit-user-theme');
const saveUserChangesBtn = document.getElementById('save-user-changes-btn');
let currentEditingUserUid = null;

// Temporary Pages DOM elements
const createTempPageForm = document.getElementById('create-temp-page-form');
const tempPageTitleInput = document.getElementById('temp-page-title');
const tempPageContentInput = document.getElementById('temp-page-content');
const tempPageList = document.getElementById('temp-page-list');
const editTempPageModal = document.getElementById('edit-temp-page-modal');
const editTempPageTitleInput = document.getElementById('edit-temp-page-title');
const editTempPageContentInput = document.getElementById('edit-temp-page-content');
const saveTempPageChangesBtn = document.getElementById('save-temp-page-changes-btn');
let currentEditingTempPageId = null;

// Todo List DOM elements
const addTodoForm = document.getElementById('add-todo-form');
const todoTaskInput = document.getElementById('todo-task');
const todoWorkerInput = document.getElementById('todo-worker');
const todoPrioritySelect = document.getElementById('todo-priority');
const todoEtaInput = document.getElementById('todo-eta');
const todoNotesInput = document.getElementById('todo-notes');
const roadmapTodoListTbody = document.getElementById('roadmap-todo-list-tbody');
const editTodoModal = document.getElementById('edit-todo-modal');
const editTodoTaskInput = document.getElementById('edit-todo-task');
const editTodoWorkerInput = document.getElementById('edit-todo-worker');
const editTodoPrioritySelect = document.getElementById('edit-todo-priority');
const editTodoEtaInput = document.getElementById('edit-todo-eta');
const editTodoNotesInput = document.getElementById('edit-todo-notes');
const saveTodoChangesBtn = document.getElementById('save-todo-changes-btn');
let currentEditingTodoId = null;


// EasyMDE instances
let easyMDECreate;
let easyMDEEdit;

const DEFAULT_THEME = 'dark';
const DEFAULT_PROFILE_PIC = 'https://placehold.co/32x32/1F2937/E5E7EB?text=AV'; // Default placeholder

/**
* Displays a custom message box for user feedback.
* @param {string} message - The message to display.
* @param {boolean} isError - True for error, false for success.
*/
function showMessageBox(message, isError) {
if (!messageBox) {
console.error("MessageBox element not found. Message:", message);
return;
}
messageBox.textContent = message;
messageBox.className = 'message-box';
if (isError) {
messageBox.classList.add('error');
} else {
messageBox.classList.add('success');
}
messageBox.style.display = 'block';
setTimeout(() => {
messageBox.style.display = 'none';
}, 5000);
}

/**
* Shows a custom confirmation modal.
* @param {string} message - The main confirmation message.
* @param {string} [subMessage=''] - An optional sub-message.
* @returns {Promise<boolean>} Resolves to true if confirmed, false if cancelled.
  */
  function showCustomConfirm(message, subMessage = '') {
  return new Promise(resolve => {
  confirmMessage.textContent = message;
  confirmSubmessage.textContent = subMessage;
  customConfirmModal.style.display = 'flex';

  const onConfirm = () => {
  customConfirmModal.style.display = 'none';
  confirmYesBtn.removeEventListener('click', onConfirm);
  confirmNoBtn.removeEventListener('click', onCancel);
  resolve(true);
  };

  const onCancel = () => {
  customConfirmModal.style.display = 'none';
  confirmYesBtn.removeEventListener('click', onConfirm);
  confirmNoBtn.removeEventListener('click', onCancel);
  resolve(false);
  };

  confirmYesBtn.addEventListener('click', onConfirm);
  confirmNoBtn.addEventListener('click', onCancel);
  });
  }

  /**
  * Fetches user profile data from Firestore.
  * @param {string} uid - The user's UID.
  * @returns {Promise<Object|null>} - User profile data or null if not found.
  */
  async function getUserProfileFromFirestore(uid) {
  // Wait for Firebase to be ready before attempting Firestore operations
  await firebaseReadyPromise;
  if (!db) {
  console.error("Firestore DB not initialized for getUserProfileFromFirestore.");
  return null;
  }
  const userDocRef = doc(db, `artifacts/${appId}/public/data/user_profiles`, uid);
  try {
  const docSnap = await getDoc(userDocRef);
  if (docSnap.exists()) {
  return docSnap.data();
  }
  } catch (error) {
  console.error("ERROR: Error fetching user profile from Firestore:", error);
  showMessageBox(`Error fetching user profile: ${error.message}`, true);
  }
  return null;
  }

  /**
  * Updates user profile data in Firestore.
  * @param {string} uid - The user's UID.
  * @param {Object} profileData - The data to update (themePreference, displayName, photoURL).
  */
  async function updateUserProfileInFirestore(uid, profileData) {
  await firebaseReadyPromise;
  if (!db) {
  showMessageBox("Database not initialized. Cannot save profile.", true);
  return false;
  }
  const userDocRef = doc(db, `artifacts/${appId}/public/data/user_profiles`, uid);
  try {
  await setDoc(userDocRef, profileData, { merge: true });
  showMessageBox("User profile updated successfully!", false);
  return true;
  } catch (error) {
  console.error("ERROR: Error updating user profile in Firestore:", error);
  showMessageBox(`Error saving profile: ${error.message}`, true);
  return false;
  }
  }

  /**
  * Deletes a user's profile from Firestore (does not delete Auth account).
  * @param {string} uid - The user's UID.
  */
  async function deleteUserProfileFromFirestore(uid) {
  await firebaseReadyPromise;
  if (!db) {
  showMessageBox("Database not initialized. Cannot delete profile.", true);
  return;
  }
  const confirmation = await showCustomConfirm(`Are you sure you want to delete user profile for UID: ${uid}?`, "This will NOT delete the Firebase Authentication account.");
  if (!confirmation) {
  showMessageBox("Deletion cancelled.", false);
  return;
  }

  const userDocRef = doc(db, `artifacts/${appId}/public/data/user_profiles`, uid);
  try {
  await deleteDoc(userDocRef);
  showMessageBox(`User profile ${uid} deleted successfully!`, false);
  renderUserList();
  } catch (error) {
  console.error("ERROR: Error deleting user profile:", error);
  showMessageBox(`Error deleting user profile: ${error.message}`, true);
  }
  }

  /**
  * Fetches all user profiles from Firestore.
  * @returns {Promise<Array>} - Array of user profile objects with their UIDs.
    */
    async function fetchAllUserProfiles() {
    await firebaseReadyPromise;
    if (!db) {
    console.error("Firestore DB not initialized for fetchAllUserProfiles.");
    return [];
    }
    const userProfilesCol = collection(db, `artifacts/${appId}/public/data/user_profiles`);
    try {
    const querySnapshot = await getDocs(userProfilesCol);
    const users = [];
    querySnapsh
