<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin & Dev - Arcator.co.uk</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts - Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <!-- EasyMDE (Markdown Editor) CSS -->
  <link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css">
  <style>
    /* Base styles for the body, applying a dark background, light text,
     * and a subtle diagonal gradient for texture. */
    body {
      font-family: 'Inter', sans-serif;
      background-color: #1F2937;
      color: #E5E7EB;
      background-image: linear-gradient(45deg, rgba(0,0,0,0.1) 25%, transparent 25%, transparent 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1) 75%, transparent 75%, transparent);
      background-size: 20px 20px; /* Size of the repeating pattern */
      background-attachment: fixed;
    }
    /* Styles for the hero banner section, including a background image,
     * sizing, positioning, and a dark overlay for text readability. */
    .hero-banner {
      background-image: url('https://jylina.arcator.co.uk/standalone/img/creativespawn.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      min-height: 250px; /* Ensures the banner has a minimum height */
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative; /* Needed for the pseudo-element overlay */
      overflow: hidden; /* Hides any overflow from the background image */
    }
    /* Pseudo-element for the dark overlay on the hero banner,
     * ensuring text readability over the background image. */
    .hero-banner::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1;
    }
    /* Styles for the content within the hero banner,
     * positioning it above the overlay and applying text shadow. */
    .hero-content {
      position: relative;
      z-index: 2;
      color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
    }
    /* Basic table styling for full width and collapsed borders. */
    table {
      width: 100%;
      border-collapse: collapse;
    }
    /* Styles for table headers and data cells, including padding,
     * text alignment, and bottom border. */
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #374151; /* Darker border for table rows */
    }
    /* Styles specifically for table headers, including background color,
     * text color, font weight, and text transformation. */
    th {
      background-color: #374151; /* Darker header background */
      color: #F87171; /* Red text for headers */
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    /* Alternating background color for even table rows for better readability. */
    tr:nth-child(even) {
      background-color: #2F3B4E; /* Slightly different background for even rows */
    }
    /* Hover effect for table rows, changing background color on mouse-over. */
    tr:hover {
      background-color: #4B5563; /* Lighter background on hover */
    }
    /* Styling for code blocks, including background, padding, border-radius,
     * font family, and overflow properties for better code display. */
    .code-block {
      background-color: #2D3748;
      padding: 1rem;
      border-radius: 0.5rem;
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
      overflow-x: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }
    /* Styles for the custom message box */
    .message-box {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #333;
      color: white;
      padding: 15px 30px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      display: none; /* Hidden by default */
      font-size: 1rem;
      text-align: center;
    }
    .message-box.success {
      background-color: #4CAF50; /* Green for success */
    }
    .message-box.error {
      background-color: #F44336; /* Red for error */
    }
    /* Modal styles */
    .modal {
      display: none; /* Hidden by default */
      position: fixed; /* Stay in place */
      z-index: 1001; /* Sit on top */
      left: 0;
      top: 0;
      width: 100%; /* Full width */
      height: 100%; /* Full height */
      overflow: auto; /* Enable scroll if needed */
      background-color: rgba(0,0,0,0.7); /* Black w/ opacity */
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background-color: #2D3748;
      margin: auto;
      padding: 20px;
      border-radius: 0.75rem;
      box-shadow: 0 5px 15px rgba(0,0,0,0.5);
      width: 80%;
      max-width: 500px;
      position: relative;
    }
    .close-button {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }
    .close-button:hover,
    .close-button:focus {
      color: white;
      text-decoration: none;
      cursor: pointer;
    }
    /* Custom confirmation modal */
    .custom-confirm-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #2D3748;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.5);
      z-index: 1002;
      text-align: center;
      color: white;
      width: 90%;
      max-width: 400px;
      display: none; /* Hidden by default */
    }
    /* EasyMDE specific styling adjustments for dark theme */
    .editor-toolbar {
      background-color: #374151 !important; /* Darker toolbar */
      border-bottom: 1px solid #4B5563 !important;
    }
    .editor-toolbar button {
      color: #E5E7EB !important; /* Lighter icons */
    }
    .editor-toolbar button.active, .editor-toolbar button:hover {
      background-color: #4B5563 !important; /* Hover/active state */
    }
    .CodeMirror, .CodeMirror-scroll {
      background-color: #1F2937 !important; /* Dark editor background */
      color: #E5E7EB !important; /* Light text */
    }
    .CodeMirror-cursor {
      border-left: 1px solid #E5E7EB !important; /* Light cursor */
    }
    .CodeMirror-selected {
      background-color: #4B5563 !important; /* Selection color */
    }
    .CodeMirror-placeholder {
      color: #6B7280 !important; /* Placeholder color */
    }
  </style>
</head>
<body class="antialiased">
<!-- Navigation Bar Placeholder -->
<div id="navbar-placeholder"></div>

<!-- Hero Section with Background Image -->
<section class="hero-banner rounded-b-lg shadow-xl">
  <div class="container mx-auto px-4 text-center hero-content">
    <h1 class="text-5xl md:text-6xl font-extrabold mb-4 leading-tight">Administration & Development</h1>
    <p class="text-xl md:text-2xl mb-8">Insights into Arcator's operations and ongoing projects.</p>
  </div>
</section>

<!-- Admin & Dev Section Content -->
<section id="admin-dev" class="py-16 bg-gray-800 rounded-lg shadow-inner mx-4 my-8">
  <div class="container mx-auto px-4">
    <!-- Loading Spinner -->
    <div id="loading-spinner" class="flex justify-center items-center h-48">
      <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
    </div>

    <!-- Login Required Message / Redirect -->
    <div id="login-required-message" class="text-center bg-gray-700 p-8 rounded-lg shadow-md mb-8" style="display: none;">
      <h2 class="text-4xl font-bold text-red-400 mb-6">Access Denied</h2>
      <p class="text-lg text-gray-300 mb-8">
        You must be logged in as an administrator to access this page.
      </p>
      <a href="sign.html" class="inline-block bg-blue-600 text-white font-bold py-3 px-8 rounded-full hover:bg-blue-700 transition duration-300 ease-in-out transform hover:scale-105 shadow-lg">Login / Sign Up</a>
    </div>

    <!-- Admin Content Section (visible only to authenticated admins) -->
    <div id="admin-content" style="display: none;">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-3xl font-bold text-red-400">Welcome, Admin <span id="admin-user-display"></span>!</h2>
        <button id="logout-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-full hover:bg-red-700 transition duration-300 ease-in-out shadow-lg">Logout</button>
      </div>

      <p class="text-lg text-gray-300 mb-8">
        This portal provides tools and information for managing Arcator infrastructure and development.
      </p>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <!-- Infrastructure Management Card (Existing) -->
        <div class="p-6 bg-gray-700 rounded-lg shadow-md">
          <h3 class="text-2xl font-bold text-blue-300 mb-4">Infrastructure Management</h3>
          <p class="text-gray-300 leading-relaxed mb-4">Monitor server health, manage deployments, and ensure network stability.</p>
          <ul class="list-disc list-inside text-gray-300 space-y-2">
            <li>Review server logs and performance metrics.</li>
            <li>Perform routine maintenance tasks.</li>
            <li>Manage user permissions on core systems.</li>
            <li>Oversee backup and recovery procedures.</li>
          </ul>
          <a href="infrastructure.html" class="inline-block bg-purple-600 text-white font-bold py-2 px-6 rounded-full mt-6 hover:bg-purple-700 transition duration-300 ease-in-out transform hover:scale-105 shadow-lg">View Infrastructure Details</a>
        </div>

        <!-- Development Tools Card (Existing) -->
        <div class="p-6 bg-gray-700 rounded-lg shadow-md">
          <h3 class="text-2xl font-bold text-blue-300 mb-4">Development Tools & Wiki</h3>
          <p class="text-gray-300 leading-relaxed mb-4">Access development resources, manage codebases, and update the Arcator Wiki.</p>
          <ul class="list-disc list-inside text-gray-300 space-y-2">
            <li>Access the code repositories and version control.</li>
            <li>Contribute to ongoing development projects.</li>
            <li>Update and maintain the official Arcator Wiki.</li>
            <li>Collaborate on new features and bug fixes.</li>
          </ul>
          <a href="https://wiki.arcator.co.uk/" target="_blank" rel="noopener noreferrer" class="inline-block bg-yellow-600 text-white font-bold py-2 px-6 rounded-full mt-6 hover:bg-yellow-700 transition duration-300 ease-in-out transform hover:scale-105 shadow-lg">Go to Arcator Wiki</a>
        </div>

        <!-- NEW: User Management Card -->
        <div class="p-6 bg-gray-700 rounded-lg shadow-md md:col-span-2">
          <h3 class="text-2xl font-bold text-blue-300 mb-4">User Management</h3>
          <p class="text-gray-300 leading-relaxed mb-4">View and manage registered user profiles.</p>
          <button id="load-users-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-full hover:bg-blue-700 transition duration-300 ease-in-out shadow-lg mb-4">Load Users</button>
          <div class="overflow-x-auto">
            <table class="w-full text-left table-auto">
              <thead>
              <tr class="bg-gray-800">
                <th class="px-4 py-2">Email</th>
                <th class="px-4 py-2">Display Name</th>
                <th class="px-4 py-2">Theme</th>
                <th class="px-4 py-2">Actions</th>
              </tr>
              </thead>
              <tbody id="user-list-tbody">
              <tr><td colspan="4" class="text-center py-4 text-gray-400">No users loaded yet. Click "Load Users".</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- NEW: Form Management Card -->
        <div class="p-6 bg-gray-700 rounded-lg shadow-md">
          <h3 class="text-2xl font-bold text-blue-300 mb-4">Form Management</h3>
          <p class="text-gray-300 leading-relaxed mb-4">Overview of form submissions and structure.</p>
          <ul class="list-disc list-inside text-gray-300 space-y-2">
            <li>Review recent form submissions.</li>
            <li>Analyze form data trends.</li>
            <li>(Future: Edit form questions/fields directly)</li>
          </ul>
          <a href="forms.html" class="inline-block bg-green-600 text-white font-bold py-2 px-6 rounded-full mt-6 hover:bg-green-700 transition duration-300 ease-in-out transform hover:scale-105 shadow-lg">Go to Forms Page</a>
        </div>

        <!-- NEW: Temporary Pages Card -->
        <div class="p-6 bg-gray-700 rounded-lg shadow-md">
          <h3 class="text-2xl font-bold text-blue-300 mb-4">Temporary Pages</h3>
          <p class="text-gray-300 leading-relaxed mb-4">Create and manage temporary informational pages.</p>
          <form id="create-temp-page-form" class="space-y-4">
            <div>
              <label for="temp-page-title" class="block text-gray-300 text-sm font-bold mb-2">Page Title:</label>
              <input type="text" id="temp-page-title" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Enter page title">
            </div>
            <div>
              <label for="temp-page-content" class="block text-gray-300 text-sm font-bold mb-2">Page Content (Markdown allowed):</label>
              <textarea id="temp-page-content" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline h-32" placeholder="Write your page content here..."></textarea>
            </div>
            <button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-full hover:bg-indigo-700 transition duration-300 ease-in-out shadow-lg">Create Temp Page</button>
          </form>
          <h4 class="text-xl font-semibold text-gray-200 mt-6 mb-3">Existing Temporary Pages:</h4>
          <ul id="temp-page-list" class="list-disc list-inside text-gray-300 space-y-2">
            <li>No temporary pages created yet.</li>
          </ul>
        </div>

        <!-- NEW: Important Links Card -->
        <div class="p-6 bg-gray-700 rounded-lg shadow-md md:col-span-2">
          <h3 class="text-2xl font-bold text-blue-300 mb-4">Important Links</h3>
          <p class="text-gray-300 leading-relaxed mb-4">Quick access to essential internal and external documentation.</p>
          <ul class="list-disc list-inside text-gray-300 space-y-2">
            <li><a href="https://docs.google.com/document/d/1WvxTStjkBbQh9dp-59v1jJbaLPuofrnk_4N12mSMFo4/edit?tab=t.0" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:underline">Arcator Internal Documentation (Google Doc)</a></li>
            <li><a href="https://wiki.arcator.co.uk/" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:underline">Arcator Official Wiki</a></li>
            <li><a href="infrastructure.html" class="text-blue-400 hover:underline">Infrastructure Details Page</a></li>
          </ul>
        </div>
      </div>

      <h2 class="text-4xl font-bold text-center mt-16 mb-12 text-red-400">Our Development Roadmap (Todo List)</h2>
      <p class="text-lg text-center mb-8 text-gray-300">This section outlines our ongoing tasks, future plans, and administrative protocols that help keep Arcator running smoothly and evolving.</p>

      <!-- NEW: Add New Todo Item Form -->
      <div class="p-6 bg-gray-700 rounded-lg shadow-md mb-8">
        <h3 class="text-2xl font-bold text-blue-300 mb-4">Add New Roadmap Task</h3>
        <form id="add-todo-form" class="space-y-4">
          <div>
            <label for="todo-task" class="block text-gray-300 text-sm font-bold mb-2">Task:</label>
            <input type="text" id="todo-task" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Enter task description" required>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label for="todo-worker" class="block text-gray-300 text-sm font-bold mb-2">Worker:</label>
              <input type="text" id="todo-worker" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Assigned worker">
            </div>
            <div>
              <label for="todo-priority" class="block text-gray-300 text-sm font-bold mb-2">Priority:</label>
              <select id="todo-priority" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                <option value="Very Low">Very Low</option>
                <option value="Low">Low</option>
                <option value="Mid">Mid</option>
                <option value="High">High</option>
                <option value="Urgent">Urgent</option>
              </select>
            </div>
            <div>
              <label for="todo-eta" class="block text-gray-300 text-sm font-bold mb-2">ETA:</label>
              <input type="text" id="todo-eta" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="e.g., 1 Day, N/A">
            </div>
          </div>
          <div>
            <label for="todo-notes" class="block text-gray-300 text-sm font-bold mb-2">Notes:</label>
            <textarea id="todo-notes" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline h-24" placeholder="Additional notes or links"></textarea>
          </div>
          <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-full hover:bg-blue-700 transition duration-300 ease-in-out shadow-lg">Add Task</button>
        </form>
      </div>


      <div class="overflow-x-auto mb-12">
        <table>
          <thead>
          <tr>
            <th>Task</th>
            <th>Worker</th>
            <th>Priority</th>
            <th>ETA</th>
            <th>Notes</th>
            <th>Actions</th> <!-- NEW: Actions column -->
          </tr>
          </thead>
          <tbody id="roadmap-todo-list-tbody">
          <!-- Todo items will be dynamically loaded here -->
          <tr><td colspan="6" class="text-center py-4 text-gray-400">Loading roadmap tasks...</td></tr>
          </tbody>
        </table>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-12 mt-16">
        <!-- Darrion API Section (Existing) -->
        <div>
          <h3 class="text-3xl font-bold mb-6 text-red-300">Darrion API</h3>
          <p class="text-lg leading-relaxed text-gray-300 mb-4">The Darrion API provides programmatic access to various Arcator service data. This allows for external tools and integrations to fetch information about our servers and services.</p>
          <h4 class="text-2xl font-semibold mb-4 text-red-200">REST API Endpoints:</h4>
          <ul class="list-disc list-inside text-gray-300 space-y-2">
            <li><span class="font-semibold text-white">GET mc.arcator.co.uk/players</span>: Gets a list of all servers and the players online.</li>
            <li><span class="font-semibold text-white">GET mc.arcator.co.uk/players/:serverName</span>: Gets a list of players on a specific gamemode.</li>
            <li><span class="font-semibold text-white">GET mc.arcator.co.uk/services</span>: Gets the online services on the machines.</li>
            <li><span class="font-semibold text-white">GET plugin updates</span></li>
          </ul>
        </div>

        <!-- GriefDetection Section (Existing) -->
        <div>
          <h3 class="text-3xl font-bold mb-6 text-red-300">Grief Detection</h3>
          <p class="text-lg leading-relaxed text-gray-300 mb-4">Our automated grief detection system performs regular checks to ensure fair gameplay and a positive environment for all. It prioritizes analysis based on player activity patterns.</p>
          <ul class="list-disc list-inside text-gray-300 space-y-2">
            <li>Regular checks for griefs and automated analysis of player actions.</li>
            <li>Prioritizes players with smaller `lastlog` + `firstlog` differences for analysis (lower playtime players checked first).</li>
            <li>Analyzes player actions using CoreProtectAPI (compares block placements vs. removals).</li>
            <!-- Added rel="noopener noreferrer" for security when opening external links -->
            <li>Includes `AutoWarn` system to log and optionally deny problematic block placements. (<a href="https://github.com/Alexxiconify/AlexxAutoWarn" target="_blank" rel="noopener noreferrer" class="text-blue-300 hover:underline">GitHub Link</a>)</li>
            <li>Statistical analysis of player activity (placed & removed blocks, materials) for future flags.</li>
          </ul>
        </div>
      </div>

      <!-- Onfim Notifications Section (Existing) -->
      <div class="mt-16">
        <h3 class="text-3xl font-bold mb-6 text-red-300">Onfim Notifications</h3>
        <p class="text-lg leading-relaxed text-gray-300 mb-4">Onfim Notifications are an automated system designed to alert staff via Discord about critical system statuses and potential issues, ensuring quick responses and minimal downtime.</p>
        <ul class="list-disc list-inside text-gray-300 space-y-2">
          <li>Warns staff on Discord when disk space is nearly full.</li>
          <li>Detects and alerts on drive corruption.</li>
          <li>Notifies if core services (Vulcan or Jylina) are not responding.</li>
          <li>Alerts when Jylina's Ngrok IP address changes.</li>
          <li>Handles `#machine-status` updates every minute.</li>
        </ul>
      </div>
    </div>
</section>

<!-- Footer Section -->
<footer class="bg-gray-900 py-8 text-center text-gray-400 rounded-t-lg shadow-inner mt-8">
  <div class="container mx-auto px-4">
    <p>© 2012 - <span id="current-year-admin-dev"></span> Arcator.co.uk. All rights reserved.</p>
    <p class="mt-2">Made with ❤️ for the Minecraft Community.</p>
    <div class="flex flex-wrap justify-center space-x-6 mt-4">
      <a href="#" class="hover:text-white transition duration-300 ease-in-out">Privacy Policy</a>
      <a href="#" class="hover:text-white transition duration-300 ease-in-out">Terms of Service</a>
      <a href="https://wiki.arcator.co.uk/" target="_blank" rel="noopener noreferrer" class="hover:text-white transition duration-300 ease-in-out">Wiki</a>
      <a href="infrastructure.html" class="hover:text-white transition duration-300 ease-in-out">Infrastructure</a>
      <a href="admin_and_dev.html" class="hover:text-white transition duration-300 ease-in-out">Admin & Dev</a>
    </div>
  </div>
</footer>

<!-- Message Box Element -->
<div id="message-box" class="message-box"></div>

<!-- Modals -->
<div id="edit-user-modal" class="modal">
  <div class="modal-content">
    <span class="close-button">&times;</span>
    <h3 class="text-xl font-bold mb-4 text-blue-300">Edit User Profile</h3>
    <div class="mb-4">
      <label for="edit-user-display-name" class="block text-gray-300 text-sm font-bold mb-2">Display Name:</label>
      <input type="text" id="edit-user-display-name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" />
    </div>
    <div class="mb-4">
      <label for="edit-user-theme" class="block text-gray-300 text-sm font-bold mb-2">Theme Preference:</label>
      <select id="edit-user-theme" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
        <option value="dark">Dark</option>
        <option value="light">Light</option>
      </select>
    </div>
    <button id="save-user-changes-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-full hover:bg-blue-700">Save Changes</button>
  </div>
</div>

<div id="edit-temp-page-modal" class="modal">
  <div class="modal-content">
    <span class="close-button">&times;</span>
    <h3 class="text-xl font-bold mb-4 text-blue-300">Edit Temporary Page</h3>
    <div class="mb-4">
      <label for="edit-temp-page-title" class="block text-gray-300 text-sm font-bold mb-2">Page Title:</label>
      <input type="text" id="edit-temp-page-title" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
    </div>
    <div class="mb-4">
      <label for="edit-temp-page-content" class="block text-gray-300 text-sm font-bold mb-2">Page Content (Markdown allowed):</label>
      <textarea id="edit-temp-page-content" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline h-48"></textarea>
    </div>
    <button id="save-temp-page-changes-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-full hover:bg-blue-700">Save Changes</button>
  </div>
</div>

<!-- NEW: Edit Todo Modal -->
<div id="edit-todo-modal" class="modal">
  <div class="modal-content">
    <span class="close-button">&times;</span>
    <h3 class="text-xl font-bold mb-4 text-blue-300">Edit Roadmap Task</h3>
    <div class="mb-4">
      <label for="edit-todo-task" class="block text-gray-300 text-sm font-bold mb-2">Task:</label>
      <input type="text" id="edit-todo-task" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
      <div>
        <label for="edit-todo-worker" class="block text-gray-300 text-sm font-bold mb-2">Worker:</label>
        <input type="text" id="edit-todo-worker" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
      </div>
      <div>
        <label for="edit-todo-priority" class="block text-gray-300 text-sm font-bold mb-2">Priority:</label>
        <select id="edit-todo-priority" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
          <option value="Very Low">Very Low</option>
          <option value="Low">Low</option>
          <option value="Mid">Mid</option>
          <option value="High">High</option>
          <option value="Urgent">Urgent</option>
        </select>
      </div>
      <div>
        <label for="edit-todo-eta" class="block text-gray-300 text-sm font-bold mb-2">ETA:</label>
        <input type="text" id="edit-todo-eta" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
      </div>
    </div>
    <div class="mb-4">
      <label for="edit-todo-notes" class="block text-gray-300 text-sm font-bold mb-2">Notes:</label>
      <textarea id="edit-todo-notes" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline h-24"></textarea>
    </div>
    <button id="save-todo-changes-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-full hover:bg-blue-700">Save Changes</button>
  </div>
</div>


<!-- Custom Confirmation Modal (for delete operations) -->
<div id="custom-confirm-modal" class="custom-confirm-modal">
  <p class="mb-4 text-lg" id="confirm-message"></p>
  <p class="mb-6 text-sm text-gray-400" id="confirm-submessage"></p>
  <button id="confirm-yes" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full mr-4">Yes</button>
  <button id="confirm-no" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-full">Cancel</button>
</div>


<!-- Firebase SDKs and Main Script -->
<script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    signOut,
    signInWithCustomToken,
    signInAnonymously
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import {
    getFirestore,
    doc,
    getDoc,
    setDoc,
    collection,
    getDocs,
    deleteDoc,
    addDoc,
    updateDoc,
    query,
    orderBy // Added orderBy for sorting todo items
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


  // Function to load the navigation bar
  async function loadNavbar() {
    try {
      const response = await fetch('navbar.html');
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      const navbarHtml = await response.text();
      document.getElementById('navbar-placeholder').innerHTML = navbarHtml;
    } catch (error) {
      console.error("Failed to load navigation bar:", error);
    }
  }

  // Firebase configuration object
  const firebaseConfig = {
    apiKey: "AIzaSyCP5Zb1CRermAKn7p_S30E8qzCbvsMxhm4",
    authDomain: "arcator-web.firebaseapp.com",
    projectId: "arcator-web",
    storageBucket: "arcator-web.firebasestorage.app",
    messagingSenderId: "1033082068049",
    appId: "1:1033082068049:web:dd154c8b188bde1930ec70",
    measurementId: "G-DJXNT1L7CM"
  };

  // Ensure global __app_id and __initial_auth_token are accessible
  const canvasAppId = typeof __app_id !== 'undefined' ? __app_id : null;
  const appId = canvasAppId || firebaseConfig.projectId || 'default-app-id';

  console.log("Client-side App ID detected:", appId);

  // Initialize Firebase App, Auth, and Firestore instances
  let app;
  let auth;
  let db;
  let isFirebaseInitialized = false;

  // DOM elements - Initialize immediately after declaration
  const loadingSpinner = document.getElementById('loading-spinner');
  const loginRequiredMessage = document.getElementById('login-required-message');
  const adminContent = document.getElementById('admin-content');
  const logoutBtn = document.getElementById('logout-btn');
  const adminUserDisplay = document.getElementById('admin-user-display');
  const messageBox = document.getElementById('message-box'); // This needs to be available early
  const customConfirmModal = document.getElementById('custom-confirm-modal');
  const confirmMessage = document.getElementById('confirm-message');
  const confirmSubmessage = document.getElementById('confirm-submessage');
  const confirmYesBtn = document.getElementById('confirm-yes');
  const confirmNoBtn = document.getElementById('confirm-no');


  // User Management DOM elements
  const loadUsersBtn = document.getElementById('load-users-btn');
  const userListTbody = document.getElementById('user-list-tbody');
  const editUserModal = document.getElementById('edit-user-modal');
  const editUserDisplayNameInput = document.getElementById('edit-user-display-name');
  const editUserThemeSelect = document.getElementById('edit-user-theme');
  const saveUserChangesBtn = document.getElementById('save-user-changes-btn');
  let currentEditingUserUid = null; // To store the UID of the user being edited

  // Temporary Pages DOM elements
  const createTempPageForm = document.getElementById('create-temp-page-form');
  const tempPageTitleInput = document.getElementById('temp-page-title');
  const tempPageContentInput = document.getElementById('temp-page-content');
  const tempPageList = document.getElementById('temp-page-list');
  const editTempPageModal = document.getElementById('edit-temp-page-modal');
  const editTempPageTitleInput = document.getElementById('edit-temp-page-title');
  const editTempPageContentInput = document.getElementById('edit-temp-page-content');
  const saveTempPageChangesBtn = document.getElementById('save-temp-page-changes-btn');
  let currentEditingTempPageId = null; // To store the ID of the temp page being edited

  // NEW: Todo List DOM elements
  const addTodoForm = document.getElementById('add-todo-form');
  const todoTaskInput = document.getElementById('todo-task');
  const todoWorkerInput = document.getElementById('todo-worker');
  const todoPrioritySelect = document.getElementById('todo-priority');
  const todoEtaInput = document.getElementById('todo-eta');
  const todoNotesInput = document.getElementById('todo-notes');
  const roadmapTodoListTbody = document.getElementById('roadmap-todo-list-tbody');
  const editTodoModal = document.getElementById('edit-todo-modal');
  const editTodoTaskInput = document.getElementById('edit-todo-task');
  const editTodoWorkerInput = document.getElementById('edit-todo-worker');
  const editTodoPrioritySelect = document.getElementById('edit-todo-priority');
  const editTodoEtaInput = document.getElementById('edit-todo-eta');
  const editTodoNotesInput = document.getElementById('edit-todo-notes');
  const saveTodoChangesBtn = document.getElementById('save-todo-changes-btn');
  let currentEditingTodoId = null;


  // EasyMDE instances
  let easyMDECreate;
  let easyMDEEdit;

  // Default theme (dark) for styling application
  const DEFAULT_THEME = 'dark';

  /**
   * Displays a custom message box for user feedback.
   * @param {string} message - The message to display.
   * @param {boolean} isError - True for error, false for success.
   */
  function showMessageBox(message, isError) {
    if (!messageBox) { // Fallback if messageBox is still not initialized for some reason
      console.error("MessageBox element not found. Message:", message);
      return;
    }
    messageBox.textContent = message;
    messageBox.className = 'message-box'; // Reset classes
    if (isError) {
      messageBox.classList.add('error');
    } else {
      messageBox.classList.add('success');
    }
    messageBox.style.display = 'block';
    setTimeout(() => {
      messageBox.style.display = 'none';
    }, 5000); // Hide after 5 seconds
  }

  // Initialize Firebase after DOM elements are defined
  try {
    app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    db = getFirestore(app);
    isFirebaseInitialized = true;
    console.log("Firebase initialized successfully.");
  } catch (e) {
    console.error("Error initializing Firebase:", e);
    showMessageBox("Error initializing Firebase. Cannot perform authentication.", true);
  }

  /**
   * Shows a custom confirmation modal.
   * @param {string} message - The main confirmation message.
   * @param {string} [subMessage=''] - An optional sub-message.
   * @returns {Promise<boolean>} Resolves to true if confirmed, false if cancelled.
   */
  function showCustomConfirm(message, subMessage = '') {
    return new Promise(resolve => {
      confirmMessage.textContent = message;
      confirmSubmessage.textContent = subMessage;
      customConfirmModal.style.display = 'flex'; // Show modal

      const onConfirm = () => {
        customConfirmModal.style.display = 'none';
        confirmYesBtn.removeEventListener('click', onConfirm);
        confirmNoBtn.removeEventListener('click', onCancel);
        resolve(true);
      };

      const onCancel = () => {
        customConfirmModal.style.display = 'none';
        confirmYesBtn.removeEventListener('click', onConfirm);
        confirmNoBtn.removeEventListener('click', onCancel);
        resolve(false);
      };

      confirmYesBtn.addEventListener('click', onConfirm);
      confirmNoBtn.addEventListener('click', onCancel);
    });
  }


  /**
   * Fetches user profile data from Firestore.
   * @param {string} uid - The user's UID.
   * @returns {Promise<Object|null>} - User profile data or null if not found.
   */
  async function getUserProfileFromFirestore(uid) {
    if (!db) {
      console.error("Firestore DB not initialized for getUserProfileFromFirestore.");
      return null;
    }
    const userDocRef = doc(db, `artifacts/${appId}/public/data/user_profiles`, uid);
    try {
      console.log(`DEBUG: Attempting to fetch user profile for UID: ${uid} from path: artifacts/${appId}/public/data/user_profiles/${uid}`);
      const docSnap = await getDoc(userDocRef);
      if (docSnap.exists()) {
        console.log("DEBUG: User profile found:", docSnap.data());
        return docSnap.data();
      } else {
        console.log("DEBUG: User profile NOT found for UID:", uid);
      }
    } catch (error) {
      console.error("ERROR: Error fetching user profile from Firestore:", error);
      showMessageBox(`Error fetching user profile: ${error.message}`, true); // Show message box for this specific error
    }
    return null;
  }

  /**
   * Updates user profile data in Firestore.
   * @param {string} uid - The user's UID.
   * @param {Object} profileData - The data to update (themePreference, displayName, photoURL).
   */
  async function updateUserProfileInFirestore(uid, profileData) {
    if (!db) {
      showMessageBox("Database not initialized. Cannot save profile.", true);
      return false;
    }
    const userDocRef = doc(db, `artifacts/${appId}/public/data/user_profiles`, uid);
    try {
      console.log(`DEBUG: Attempting to update user profile for UID: ${uid} with data:`, profileData);
      await setDoc(userDocRef, profileData, { merge: true }); // Use merge to avoid overwriting other fields
      console.log("DEBUG: User profile updated in Firestore:", uid, profileData);
      showMessageBox("User profile updated successfully!", false);
      return true;
    } catch (error) {
      console.error("ERROR: Error updating user profile in Firestore:", error);
      showMessageBox(`Error saving profile: ${error.message}`, true);
      return false;
    }
  }

  /**
   * Deletes a user's profile from Firestore (does not delete Auth account).
   * @param {string} uid - The user's UID.
   */
  async function deleteUserProfileFromFirestore(uid) {
    if (!db) {
      showMessageBox("Database not initialized. Cannot delete profile.", true);
      return;
    }
    const confirmation = await showCustomConfirm(`Are you sure you want to delete user profile for UID: ${uid}?`, "This will NOT delete the Firebase Authentication account.");
    if (!confirmation) {
      showMessageBox("Deletion cancelled.", false);
      return; // User cancelled
    }

    const userDocRef = doc(db, `artifacts/${appId}/public/data/user_profiles`, uid);
    try {
      console.log(`DEBUG: Attempting to delete user profile for UID: ${uid} from path: artifacts/${appId}/public/data/user_profiles/${uid}`);
      await deleteDoc(userDocRef);
      console.log("DEBUG: User profile deleted successfully:", uid);
      showMessageBox(`User profile ${uid} deleted successfully!`, false);
      renderUserList(); // Refresh list
    } catch (error) {
      console.error("ERROR: Error deleting user profile:", error);
      showMessageBox(`Error deleting user profile: ${error.message}`, true);
    }
  }

  /**
   * Fetches all user profiles from Firestore.
   * @returns {Promise<Array>} - Array of user profile objects with their UIDs.
   */
  async function fetchAllUserProfiles() {
    if (!db) {
      console.error("Firestore DB not initialized for fetchAllUserProfiles.");
      return [];
    }
    const userProfilesCol = collection(db, `artifacts/${appId}/public/data/user_profiles`);
    try {
      console.log(`DEBUG: Attempting to fetch all user profiles from collection: artifacts/${appId}/public/data/user_profiles`);
      const querySnapshot = await getDocs(userProfilesCol);
      const users = [];
      querySnapshot.forEach((doc) => {
        users.push({ id: doc.id, ...doc.data() });
      });
      console.log("DEBUG: Fetched user profiles:", users);
      return users;
    } catch (error) {
      console.error("ERROR: Error fetching all user profiles:", error);
      showMessageBox(`Error loading users: ${error.message}`, true);
      return [];
    }
  }

  /**
   * Renders the list of users in the table.
   */
  async function renderUserList() {
    userListTbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-400">Loading users...</td></tr>';
    const users = await fetchAllUserProfiles();
    userListTbody.innerHTML = ''; // Clear existing
    if (users.length === 0) {
      userListTbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-400">No user profiles found.</td></tr>';
      return;
    }

    users.forEach(user => {
      const row = userListTbody.insertRow();
      row.innerHTML = `
        <td class="px-4 py-2 break-all">${user.id}</td>
        <td class="px-4 py-2">${user.displayName || 'N/A'}</td>
        <td class="px-4 py-2">${user.themePreference || DEFAULT_THEME}</td>
        <td class="px-4 py-2">
          <button class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded-md text-sm mr-2 edit-user-btn" data-uid="${user.id}" data-displayname="${user.displayName || ''}" data-theme="${user.themePreference || DEFAULT_THEME}">Edit</button>
          <button class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-md text-sm delete-user-btn" data-uid="${user.id}">Delete Profile</button>
        </td>
      `;
    });

    // Attach event listeners to new buttons
    document.querySelectorAll('.edit-user-btn').forEach(button => {
      button.addEventListener('click', (event) => {
        const uid = event.target.dataset.uid;
        const displayName = event.target.dataset.displayname;
        const theme = event.target.dataset.theme;
        openEditUserModal(uid, displayName, theme);
      });
    });

    document.querySelectorAll('.delete-user-btn').forEach(button => {
      button.addEventListener('click', (event) => {
        const uid = event.target.dataset.uid;
        deleteUserProfileFromFirestore(uid);
      });
    });
  }

  /**
   * Opens the modal for editing a user's profile.
   * @param {string} uid - The UID of the user to edit.
   * @param {string} displayName - The current display name.
   * @param {string} theme - The current theme preference.
   */
  function openEditUserModal(uid, displayName, theme) {
    currentEditingUserUid = uid;
    editUserDisplayNameInput.value = displayName;
    editUserThemeSelect.value = theme;
    editUserModal.style.display = 'flex'; // Use flex to center
  }

  // Handle saving user changes from modal
  if (saveUserChangesBtn) {
    saveUserChangesBtn.addEventListener('click', async () => {
      if (!currentEditingUserUid) return;
      const newDisplayName = editUserDisplayNameInput.value.trim();
      const newTheme = editUserThemeSelect.value;
      const success = await updateUserProfileInFirestore(currentEditingUserUid, {
        displayName: newDisplayName,
        themePreference: newTheme
      });
      if (success) {
        editUserModal.style.display = 'none'; // Close modal
        renderUserList(); // Refresh user list in the table
      }
    });
  }

  // Close modal buttons
  document.querySelectorAll('.close-button').forEach(button => {
    button.addEventListener('click', () => {
      editUserModal.style.display = 'none';
      editTempPageModal.style.display = 'none';
      editTodoModal.style.display = 'none'; // Close todo modal
    });
  });

  // Close modal if user clicks outside of it
  window.addEventListener('click', (event) => {
    if (event.target === editUserModal) {
      editUserModal.style.display = 'none';
    }
    if (event.target === editTempPageModal) {
      editTempPageModal.style.display = 'none';
    }
    if (event.target === editTodoModal) { // Close todo modal
      editTodoModal.style.display = 'none';
    }
    if (event.target === customConfirmModal) { // Close custom confirm too
      customConfirmModal.style.display = 'none';
    }
  });


  // Temporary Pages Functions

  /**
   * Creates a new temporary page in Firestore.
   * @param {string} title - The title of the page.
   * @param {string} content - The content of the page (Markdown allowed).
   */
  async function createTempPage(title, content) {
    if (!db) {
      showMessageBox("Database not initialized. Cannot create page.", true);
      return;
    }
    const tempPagesCol = collection(db, `artifacts/${appId}/public/data/temp_pages`);
    try {
      console.log(`DEBUG: Attempting to create temp page with title: "${title}" in collection: artifacts/${appId}/public/data/temp_pages`);
      const docRef = await addDoc(tempPagesCol, {
        title: title,
        content: content,
        createdAt: new Date(),
        updatedAt: new Date(),
        authorUid: auth.currentUser ? auth.currentUser.uid : 'anonymous'
      });
      console.log("DEBUG: Temporary page created successfully with ID:", docRef.id);
      showMessageBox("Temporary page created successfully!", false);
      tempPageTitleInput.value = '';
      easyMDECreate.value(''); // Clear the editor content
      renderTempPages(); // Refresh list
    } catch (error) {
      console.error("ERROR: Error creating temporary page:", error);
      showMessageBox(`Error creating page: ${error.message}`, true);
    }
  }

  /**
   * Fetches all temporary pages from Firestore.
   * @returns {Promise<Array>} - Array of temporary page objects with their IDs.
   */
  async function fetchAllTempPages() {
    if (!db) {
      console.error("Firestore DB not initialized for fetchAllTempPages.");
      return [];
    }
    const tempPagesCol = collection(db, `artifacts/${appId}/public/data/temp_pages`);
    try {
      console.log(`DEBUG: Attempting to fetch all temporary pages from collection: artifacts/${appId}/public/data/temp_pages`);
      const querySnapshot = await getDocs(tempPagesCol);
      const pages = [];
      querySnapshot.forEach((doc) => {
        pages.push({ id: doc.id, ...doc.data() });
      });
      console.log("DEBUG: Fetched temporary pages:", pages);
      return pages;
    } catch (error) {
      console.error("ERROR: Error fetching temporary pages:", error);
      showMessageBox(`Error loading temporary pages: ${error.message}`, true);
      return [];
    }
  }

  /**
   * Renders the list of temporary pages.
   */
  async function renderTempPages() {
    tempPageList.innerHTML = '<li>Loading temporary pages...</li>';
    const pages = await fetchAllTempPages();
    tempPageList.innerHTML = ''; // Clear existing
    if (pages.length === 0) {
      tempPageList.innerHTML = '<li>No temporary pages created yet.</li>';
      return;
    }

    pages.forEach(page => {
      const li = document.createElement('li');
      li.classList.add('flex', 'flex-col', 'md:flex-row', 'md:items-center', 'justify-between', 'bg-gray-700', 'p-3', 'rounded-md', 'mb-2');
      li.innerHTML = `
        <span class="font-semibold text-white break-all md:w-3/5">${page.title}</span>
        <div class="mt-2 md:mt-0 md:w-2/5 md:text-right">
          <a href="#" class="text-blue-400 hover:underline text-sm mr-2 view-temp-page" data-id="${page.id}">View</a>
          <button class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded-md text-sm mr-2 edit-temp-page-btn" data-id="${page.id}" data-title="${page.title}" data-content="${page.content}">Edit</button>
          <button class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-md text-sm delete-temp-page-btn" data-id="${page.id}">Delete</button>
        </div>
      `;
      tempPageList.appendChild(li);
    });

    // Attach event listeners for new buttons created by renderTempPages
    document.querySelectorAll('.view-temp-page').forEach(link => {
      link.addEventListener('click', (event) => {
        event.preventDefault();
        const pageId = event.target.dataset.id;
        window.open(`temp-page-viewer.html?id=${pageId}`, '_blank');
      });
    });
    document.querySelectorAll('.edit-temp-page-btn').forEach(button => {
      button.addEventListener('click', (event) => {
        const id = event.target.dataset.id;
        const title = event.target.dataset.title;
        const content = event.target.dataset.content;
        openEditTempPageModal(id, title, content);
      });
    });
    document.querySelectorAll('.delete-temp-page-btn').forEach(button => {
      button.addEventListener('click', (event) => {
        const id = event.target.dataset.id;
        deleteTempPage(id);
      });
    });
  }

  /**
   * Opens the modal for editing a temporary page.
   * @param {string} id - The ID of the page to edit.
   * @param {string} title - The current title.
   * @param {string} content - The current content.
   */
  function openEditTempPageModal(id, title, content) {
    currentEditingTempPageId = id;
    editTempPageTitleInput.value = title;

    // Initialize or update EasyMDE for the edit modal
    if (!easyMDEEdit) {
      easyMDEEdit = new EasyMDE({
        element: document.getElementById('edit-temp-page-content'),
        spellChecker: false,
        forceSync: true, // Crucial to ensure textarea value is updated
        minHeight: "200px",
        toolbar: ["bold", "italic", "heading", "|", "quote", "unordered-list", "ordered-list", "|", "link", "image", "|", "guide"]
      });
    }
    easyMDEEdit.value(content); // Set the content to the editor

    editTempPageModal.style.display = 'flex';
  }

  // Handle saving temp page changes from modal
  if (saveTempPageChangesBtn) {
    saveTempPageChangesBtn.addEventListener('click', async () => {
      if (!currentEditingTempPageId) return;
      const newTitle = editTempPageTitleInput.value.trim();
      const newContent = easyMDEEdit.value().trim(); // Get content from EasyMDE
      if (!newTitle || !newContent) {
        showMessageBox("Title and Content cannot be empty.", true);
        return;
      }
      const tempPageDocRef = doc(db, `artifacts/${appId}/public/data/temp_pages`, currentEditingTempPageId);
      try {
        console.log(`DEBUG: Attempting to update temp page ID: ${currentEditingTempPageId} with new title: "${newTitle}"`);
        await updateDoc(tempPageDocRef, {
          title: newTitle,
          content: newContent,
          updatedAt: new Date()
        });
        console.log("DEBUG: Temporary page updated successfully.");
        showMessageBox("Temporary page updated successfully!", false);
        editTempPageModal.style.display = 'none';
        renderTempPages(); // Refresh list
      } catch (error) {
        console.error("ERROR: Error updating temporary page:", error);
        showMessageBox(`Error updating page: ${error.message}`, true);
      }
    });
  }

  /**
   * Deletes a temporary page from Firestore.
   * @param {string} id - The ID of the page to delete.
   */
  async function deleteTempPage(id) {
    if (!db) {
      showMessageBox("Database not initialized. Cannot delete page.", true);
      return;
    }
    // Using a custom modal instead of browser's confirm() due to iframe restrictions
    const confirmation = await showCustomConfirm("Are you sure you want to delete this temporary page?", "This action cannot be undone.");

    if (!confirmation) {
      showMessageBox("Deletion cancelled.", false);
      return; // User cancelled
    }

    const tempPageDocRef = doc(db, `artifacts/${appId}/public/data/temp_pages`, id);
    try {
      console.log(`DEBUG: Attempting to delete temp page ID: ${id} from path: artifacts/${appId}/public/data/temp_pages/${id}`);
      await deleteDoc(tempPageDocRef);
      console.log("DEBUG: Temporary page deleted successfully.");
      showMessageBox("Temporary page deleted successfully!", false);
      renderTempPages(); // Refresh list
    } catch (error) {
      console.error("ERROR: Error deleting temporary page:", error);
      showMessageBox(`Error deleting page: ${error.message}`, true);
    }
  }

  /**
   * Applies the selected theme to the body element.
   * @param {string} theme - 'dark' or 'light'.
   */
  function applyTheme(theme) {
    const body = document.body;
    body.classList.remove('theme-dark', 'theme-light');
    if (theme === 'light') {
      body.classList.add('theme-light');
    } else {
      body.classList.add('theme-dark');
    }
  }

  /**
   * Updates the UI based on the user's authentication and admin status.
   * @param {Object|null} user - The Firebase User object or null.
   */
  async function updateAdminUI(user) {
    loadingSpinner.style.display = 'none'; // Hide spinner once auth state is determined

    if (user) {
      console.log("DEBUG: Authenticated User UID:", user.uid);
      console.log("DEBUG: Authenticated User Email:", user.email);

      // Fetch user profile to get theme preference and display name
      const userProfile = await getUserProfileFromFirestore(user.uid);
      const themePreference = userProfile?.themePreference || DEFAULT_THEME;
      applyTheme(themePreference);

      // Check if user is a whitelisted admin
      const adminDocRef = doc(db, `artifacts/${appId}/public/data/whitelisted_admins`, user.uid);
      try {
        console.log(`DEBUG: Checking admin whitelist document at: artifacts/${appId}/public/data/whitelisted_admins/${user.uid}`);
        const adminDocSnap = await getDoc(adminDocRef);
        if (adminDocSnap.exists()) {
          // User is an admin
          console.log("DEBUG: User is confirmed as ADMIN in Firestore.");
          loginRequiredMessage.style.display = 'none';
          adminContent.style.display = 'block';
          adminUserDisplay.textContent = userProfile?.displayName || user.displayName || user.email || user.uid; // Display user info
          // Load data for admin sections once user is confirmed as admin
          renderUserList();
          renderTempPages();
          renderTodoList(); // Render the todo list
        } else {
          // User is logged in but not an admin
          console.log("DEBUG: User is NOT in whitelisted_admins collection.");
          loginRequiredMessage.style.display = 'block';
          adminContent.style.display = 'none';
          showMessageBox("You are logged in, but do not have admin privileges.", true);
        }
      } catch (error) {
        console.error("ERROR: Error checking admin whitelist:", error);
        loginRequiredMessage.style.display = 'block';
        adminContent.style.display = 'none';
        showMessageBox("Error checking admin status. Please try again.", true);
      }
    } else {
      // No user is logged in
      console.log("DEBUG: No user is currently authenticated.");
      loginRequiredMessage.style.display = 'block';
      adminContent.style.display = 'none';
      applyTheme(DEFAULT_THEME); // Apply default theme if no user
    }
  }

  // NEW: Todo List Functions
  /**
   * Adds a new todo item to Firestore.
   */
  async function addTodoItem(task, worker, priority, eta, notes) {
    if (!db) {
      showMessageBox("Database not initialized. Cannot add task.", true);
      return;
    }
    const todosCol = collection(db, `artifacts/${appId}/public/data/roadmap_todos`);
    try {
      await addDoc(todosCol, {
        task: task,
        worker: worker,
        priority: priority,
        eta: eta,
        notes: notes,
        createdAt: new Date()
      });
      showMessageBox("Task added successfully!", false);
      // Clear form
      todoTaskInput.value = '';
      todoWorkerInput.value = '';
      todoPrioritySelect.value = 'Low';
      todoEtaInput.value = '';
      todoNotesInput.value = '';
      renderTodoList(); // Refresh list
    } catch (error) {
      console.error("Error adding todo item:", error);
      showMessageBox(`Error adding task: ${error.message}`, true);
    }
  }

  /**
   * Fetches all todo items from Firestore.
   * @returns {Promise<Array>} - Array of todo item objects with their IDs.
   */
  async function fetchAllTodoItems() {
    if (!db) {
      console.error("Firestore DB not initialized for fetchAllTodoItems.");
      return [];
    }
    const todosCol = collection(db, `artifacts/${appId}/public/data/roadmap_todos`);
    // Order by creation date to maintain a consistent list order
    const q = query(todosCol, orderBy("createdAt", "asc"));
    try {
      const querySnapshot = await getDocs(q);
      const todos = [];
      querySnapshot.forEach((doc) => {
        todos.push({ id: doc.id, ...doc.data() });
      });
      return todos;
    } catch (error) {
      console.error("Error fetching todo items:", error);
      showMessageBox(`Error loading tasks: ${error.message}`, true);
      return [];
    }
  }

  /**
   * Renders the list of todo items in the table.
   */
  async function renderTodoList() {
    roadmapTodoListTbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-400">Loading roadmap tasks...</td></tr>';
    const todos = await fetchAllTodoItems();
    roadmapTodoListTbody.innerHTML = ''; // Clear existing
    if (todos.length === 0) {
      roadmapTodoListTbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-400">No roadmap tasks found. Add a new task above.</td></tr>';
      return;
    }

    todos.forEach(todo => {
      const row = roadmapTodoListTbody.insertRow();
      row.innerHTML = `
        <td class="px-4 py-2">${todo.task || 'N/A'}</td>
        <td class="px-4 py-2">${todo.worker || 'N/A'}</td>
        <td class="px-4 py-2">${todo.priority || 'N/A'}</td>
        <td class="px-4 py-2">${todo.eta || 'N/A'}</td>
        <td class="px-4 py-2 break-all">${todo.notes || 'N/A'}</td>
        <td class="px-4 py-2">
          <button class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded-md text-sm mr-2 edit-todo-btn"
                  data-id="${todo.id}" data-task="${todo.task || ''}" data-worker="${todo.worker || ''}"
                  data-priority="${todo.priority || ''}" data-eta="${todo.eta || ''}" data-notes="${todo.notes || ''}">Edit</button>
          <button class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-md text-sm delete-todo-btn" data-id="${todo.id}">Delete</button>
        </td>
      `;
    });

    // Attach event listeners to new buttons
    document.querySelectorAll('.edit-todo-btn').forEach(button => {
      button.addEventListener('click', (event) => {
        const { id, task, worker, priority, eta, notes } = event.target.dataset;
        openEditTodoModal(id, task, worker, priority, eta, notes);
      });
    });

    document.querySelectorAll('.delete-todo-btn').forEach(button => {
      button.addEventListener('click', (event) => {
        const id = event.target.dataset.id;
        deleteTodoItem(id);
      });
    });
  }

  /**
   * Opens the modal for editing a todo item.
   */
  function openEditTodoModal(id, task, worker, priority, eta, notes) {
    currentEditingTodoId = id;
    editTodoTaskInput.value = task;
    editTodoWorkerInput.value = worker;
    editTodoPrioritySelect.value = priority;
    editTodoEtaInput.value = eta;
    editTodoNotesInput.value = notes;
    editTodoModal.style.display = 'flex';
  }

  /**
   * Updates a todo item in Firestore.
   */
  async function updateTodoItem(id, task, worker, priority, eta, notes) {
    if (!db) {
      showMessageBox("Database not initialized. Cannot save changes.", true);
      return;
    }
    const todoDocRef = doc(db, `artifacts/${appId}/public/data/roadmap_todos`, id);
    try {
      await updateDoc(todoDocRef, {
        task: task,
        worker: worker,
        priority: priority,
        eta: eta,
        notes: notes,
        updatedAt: new Date()
      });
      showMessageBox("Task updated successfully!", false);
      editTodoModal.style.display = 'none';
      renderTodoList(); // Refresh list
    } catch (error) {
      console.error("Error updating todo item:", error);
      showMessageBox(`Error updating task: ${error.message}`, true);
    }
  }

  /**
   * Deletes a todo item from Firestore.
   */
  async function deleteTodoItem(id) {
    if (!db) {
      showMessageBox("Database not initialized. Cannot delete task.", true);
      return;
    }
    const confirmation = await showCustomConfirm("Are you sure you want to delete this roadmap task?", "This action cannot be undone.");
    if (!confirmation) {
      showMessageBox("Deletion cancelled.", false);
      return;
    }

    const todoDocRef = doc(db, `artifacts/${appId}/public/data/roadmap_todos`, id);
    try {
      await deleteDoc(todoDocRef);
      showMessageBox("Task deleted successfully!", false);
      renderTodoList(); // Refresh list
    } catch (error) {
      console.error("Error deleting todo item:", error);
      showMessageBox(`Error deleting task: ${error.message}`, true);
    }
  }

  // Load navbar and initialize EasyMDE on page load
  window.onload = function() {
    loadNavbar();
    document.getElementById('current-year-admin-dev').textContent = new Date().getFullYear();

    // Initialize EasyMDE for the create temporary page form
    easyMDECreate = new EasyMDE({
      element: document.getElementById('temp-page-content'),
      spellChecker: false,
      forceSync: true, // Crucial to ensure textarea value is updated
      minHeight: "200px",
      toolbar: ["bold", "italic", "heading", "|", "quote", "unordered-list", "ordered-list", "|", "link", "image", "|", "guide"]
    });
  };

  // Set up Firebase Authentication listener
  if (isFirebaseInitialized && auth) {
    onAuthStateChanged(auth, (user) => {
      updateAdminUI(user);
    });

    // Handle initial custom token sign-in for Canvas environment only if no user already authenticated
    if (typeof __initial_auth_token !== 'undefined' && !auth.currentUser) {
      signInWithCustomToken(auth, __initial_auth_token)
        .then(() => {
          console.log("DEBUG: Signed in with custom token from Canvas (admin_dev page).");
        })
        .catch((error) => {
          console.error("ERROR: Error signing in with custom token (admin_dev page):", error);
          // Fallback to anonymous sign-in if custom token fails (e.g., expired)
          signInAnonymously(auth)
            .then(() => console.log("DEBUG: Signed in anonymously (admin_dev page) after custom token failure."))
            .catch((anonError) => console.error("ERROR: Error signing in anonymously (admin_dev page):", anonError));
        });
    } else if (!auth.currentUser) {
      // If no custom token and no current user, sign in anonymously by default
      signInAnonymously(auth)
        .then(() => console.log("DEBUG: Signed in anonymously (no custom token) on admin_dev page."))
        .catch((anonError) => console.error("ERROR: Error signing in anonymously (admin_dev page):", anonError));
    }
  }

  // Event Listener for Logout Button
  if (logoutBtn) {
    logoutBtn.addEventListener('click', async () => {
      showMessageBox("", false); // Clear any existing messages
      try {
        await signOut(auth);
        console.log("DEBUG: User signed out.");
        showMessageBox("You have been signed out.", false);
        // updateAdminUI will be called by onAuthStateChanged
      } catch (error) {
        console.error("ERROR: Logout failed:", error);
        showMessageBox("Logout failed. Please try again. Error: " + (error.message || "Unknown error"), true);
      }
    });
  }

  // Attach event listeners for new functionalities
  if (loadUsersBtn) {
    loadUsersBtn.addEventListener('click', renderUserList);
  }

  if (createTempPageForm) {
    createTempPageForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const title = tempPageTitleInput.value.trim();
      const content = easyMDECreate.value().trim(); // Get content from EasyMDE
      if (!title || !content) {
        showMessageBox("Please enter both title and content for the temporary page.", true);
        return;
      }
      await createTempPage(title, content);
    });
  }

  // NEW: Add todo item event listener
  if (addTodoForm) {
    addTodoForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const task = todoTaskInput.value.trim();
      const worker = todoWorkerInput.value.trim();
      const priority = todoPrioritySelect.value;
      const eta = todoEtaInput.value.trim();
      const notes = todoNotesInput.value.trim();

      if (!task) {
        showMessageBox("Task description is required.", true);
        return;
      }
      await addTodoItem(task, worker, priority, eta, notes);
    });
  }

  // NEW: Save todo changes event listener
  if (saveTodoChangesBtn) {
    saveTodoChangesBtn.addEventListener('click', async () => {
      if (!currentEditingTodoId) return;
      const task = editTodoTaskInput.value.trim();
      const worker = editTodoWorkerInput.value.trim();
      const priority = editTodoPrioritySelect.value;
      const eta = editTodoEtaInput.value.trim();
      const notes = editTodoNotesInput.value.trim();

      if (!task) {
        showMessageBox("Task description is required.", true);
        return;
      }
      await updateTodoItem(currentEditingTodoId, task, worker, priority, eta, notes);
    });
  }
</script>
</body>
</html>
